---
title: "Transparency Analysis"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
  html_notebook: default
---
# Setup
```{r setup}
## Libraries
library(tidyverse)
library(magrittr)
library(tidylog)
library(gt)
library(grid)
library(egg)
library(gtable)
library(patchwork)
library(webshot)
options("tidylog.display" = list())  # turn off
```
```{r, include=FALSE}
## Bring in proposal event database
source("PrepData.R",verbose=FALSE)
```
```{r}
## Transparency data table
proptrans.df <- propfull.df
# TODO: Experiment with expss for labelling 
#proptrans.df %<>% set_value_labels(edon=setNames(statecodes.df$edon,as.list(statecodes.df$tla)))

proptrans.df %<>% rowwise() %>% mutate(hasplan=!is.null(plan)) # indicator for presence of plan spec in data
#proptrans.df %<>% select(-plan) # drop full plan tibble for computation efficiency since its big, and we don't use it further
proptrans.df %<>% mutate(year=as.integer(year))
proptrans.df %<>% rowwise() %>% mutate(VALIDPLAN=(is.na(INVALID)|!INVALID)&!is.na(PROPOSED)) 

```
```{r}
## For the purpose of simplifying presentation of analysis recode {INE, Junta, CLV} -> Admin; PRD51 to PRD
## Note that PRD51 represents corrected proposals by PRD (after submitting invalid proposals)
## Junta, CLV, derfe are parts of INE
proptrans.df %<>% rowwise() %<>% mutate(actor2=case_when(actor=="PRD51"~"PRD", TRUE ~ actor))
proptrans.df %<>% rowwise() %>% mutate(actortype2=as.character(actortype), actortype2=if_else(actor2=="PRD","major",actortype2))
proptrans.df %<>% rowwise() %<>% mutate(actor2=ifelse(actor2 %in% c("Junta","CLV","derfe"),"INE",actor2))
```
```{r}
## create summary df of contest events (by  year, edon)
contestSum.df <-proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(2))) %>% group_by(year,edon) %>% summarize(phase2_plans=list(na.omit(rscore)))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(2)),actortype %in% c("major","minor")) %>% group_by(year,edon) %>% summarize(phase2_plans_party=list(na.omit(rscore))))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(4))) %>% group_by(year,edon) %>% summarize(phase4_plans=list(na.omit(rscore))))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(4)),actortype %in% c("major","minor")) %>% group_by(year,edon) %>% summarize(phase4_plans_party=list(na.omit(rscore))))


contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==3 ) %>% group_by(year,edon) %>% transmute(phase3_win=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==1 ) %>% group_by(year,edon) %>% transmute(phase1_start=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==5 ) %>% group_by(year,edon) %>% transmute(final_win=rscore))

# code off-cycle interventions
contestSum.df %<>% rowwise() %>% mutate(INEchanged_phase3 = !phase3_win %in% c(phase2_plans,phase1_start))
contestSum.df %<>% rowwise() %>% mutate(INEchanged_final = !final_win %in% c(phase4_plans,phase3_win))

# code for best scores
contestSum.df %<>% rowwise() %>% mutate(lowestvalid = min(phase1_start,phase2_plans,phase3_win,phase4_plans),phase2_lowest = min(phase1_start,phase2_plans),final_lowest=min(phase3_win,phase4_plans),best_lost=final_win!=lowestvalid)

# code for sec8 & rules violations
contestSum.df %<>% rowwise() %>% mutate(phase2_unanimous=(length(unique(phase2_plans_party))==1), final_unanimous=length(unique(phase4_plans_party))==1)
contestSum.df %<>% rowwise() %>% mutate( phase2_notlow = (phase3_win>min(phase2_lowest,phase1_start)), final_notlow = (final_win>min(final_lowest,phase3_win)))
contestSum.df %<>% rowwise() %>% mutate( phase2_section8 = ( phase2_notlow & phase2_unanimous ), final_section8 = ( final_notlow & final_unanimous )) 
contestSum.df %<>% rowwise() %>% mutate( phase2_violation = ( phase2_notlow & !phase2_unanimous ), final_violation = ( final_notlow & !final_unanimous )) 
```
```{r}
## Create Plan Data Structure
 planProp.df <- proptrans.df %>% filter(!is.na(planid)) %>% group_by(planid) %>% summarize(stages=list(sort(unique(stage))),rscore=unique(rscore),edon=unique(edon),year=unique(year),VALIDPLAN=unique(VALIDPLAN),tla=unique(tla), hasplan=unique(hasplan))
planProp.df %<>% rowwise() %<>% mutate(win_final=(5 %in% stages))
planProp.df %<>% rowwise() %>% mutate(first_appeared=stages[[1]])

# finding creators is a nested op, breaking this up for readability
tmpCreators <- left_join(proptrans.df %>% filter(!is.na(planid)), planProp.df %>% select(planid,first_appeared)) %>% filter(stage==first_appeared) %>% group_by(planid) %>% summarize(creators=list(unique(actor2)))  
planProp.df %<>% left_join(tmpCreators)
rm(tmpCreators)

# fill in outcome characteristics
planProp.df %<>% left_join( contestSum.df %>% select( year, edon, lowestvalid, phase2_lowest, final_lowest, phase2_unanimous, final_unanimous, final_section8, final_violation ))
planProp.df %<>% mutate(unanimous_creator=(first_appeared==2 & phase2_unanimous) | (first_appeared==4 & final_unanimous) )
planProp.df %<>% mutate( best_plan = ( rscore==lowestvalid & VALIDPLAN ))

planProp.df %<>% 
   group_by(year,edon) %>% 
   filter(hasplan) %>% 
   mutate(best_nonmissing_score=min(rscore)) %>% 
   rowwise() %>% mutate(best_nonmissing=(rscore==best_nonmissing_score)) %>%
   select(-best_nonmissing_score) %>% 
   ungroup()

planProp.df %<>% mutate( win_section8 = win_final & final_section8)
planProp.df %<>% mutate( win_violation = win_final & final_violation)
planProp.df %<>% select( -lowestvalid, -phase2_lowest, -final_lowest, -phase2_unanimous, -final_unanimous, -final_section8, -final_violation )

# label by creator
# TODO: treat ADMIN types  CLV and Junta in other phases as admin
planProp.df %<>% rowwise() %>% mutate( creator_label = case_when(
    first_appeared ==1 ~ "ALGORITHM",
    first_appeared ==3 ~ "INE",
    first_appeared ==5 ~ "INE",
    length(creators)==1 ~ "SINGLE",# creators[[1]],
    (length(creators)>1 & unanimous_creator) ~ "UNANIMOUS",
    TRUE ~ "Coalition")
)
planProp.df %<>% rowwise() %>% mutate( creator_label = factor(creator_label))
planProp.df %<>% rowwise() %>% mutate( creator_coded = case_when(
    first_appeared ==1 ~ "ALGORITHM",
    first_appeared ==3 ~ "INE",
    first_appeared ==5 ~ "INE",
    length(creators)==1 ~ creators[[1]],
    (length(creators)>1 & unanimous_creator) ~ "UNANIMOUS",
    TRUE ~ "Coalition")
)
```
#Transparency Analysis
```{r}
##set themes for look and feel of tables


gt_theme_538 <- function(data,...) {
  data %>%
  opt_all_caps()  %>%
  opt_table_font(
    font = list(
      google_font("Chivo"),
      default_fonts()
    )
  ) %>%
    tab_style(
      style = cell_borders(
        sides = "bottom", color = "transparent", weight = px(2)
      ),
      locations = cells_body(
        columns = everything(),
        # This is a relatively sneaky way of changing the bottom border
        # Regardless of data size
        rows = nrow(data$`_data`)
      )
    )  %>% 
  tab_options(
    column_labels.background.color = "white",
    table.border.top.width = px(3),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table.border.bottom.width = px(3),
    column_labels.border.top.width = px(3),
    column_labels.border.top.color = "transparent",
    column_labels.border.bottom.width = px(3),
    column_labels.border.bottom.color = "black",
    data_row.padding = px(3),
    source_notes.font.size = 12,
    table.font.size = 16,
    heading.align = "left",
    c(...)
  ) 
}
```
## Third Party Actors
*  All scored entries are in 2013
* Unspecificed actors - Junta, CLV, PRD51
* Plans are scored, but not included for ghostprop
* Also 2017 Jalisco plan by derfe/INE in archive of plans but not officially scored
```{r}
thirdparty.tab <- proptrans.df %>% group_by(year,actor2) %>% summarise (
  outside=sum(PROPOSED & actortype2 %in% c("admin","other") & stage %in% c(2,4),na.rm=TRUE),
  missing=sum(!is.na(PROPOSED) & PROPOSED & !hasplan),
  unscored=sum(!is.na(PROPOSED) & !PROPOSED & hasplan ),
  grandtotal=outside+missing+unscored,
) 
thirdparty.tab %>% 
  filter(grandtotal>0) %>%
  select(-grandtotal,-outside) %>%
  gt()  %>%
  cols_label( "actor2" = "Actor","missing"="Missing Plans","unscored"="Nonscored" ) %>%
  tab_header(title="Undocumented Proposals") %>%
  tab_source_note(
    source_note = "Note: Admin proposals do not include interventions during decision phase to change plans." ) %>%
  data_color( 
      columns = vars(missing,unscored), 
      colors = scales::col_numeric( 
      palette = c( "white","orange"), 
        domain = c(0,7) 
      )
  ) %>% 
  gt_theme_538() 
```
## Process Overview
```{r  fig.height=2, fig.width=10 }
procColors <- planProp.df %>% filter(VALIDPLAN) %>%
  scale_color_hue("creator_label",drop=FALSE)
zoom1<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2013, edon==15) %>% 
   ggplot(aes(x=stages,y=rscore,group=planid,color=creator_label))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.2,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+
    scale_color_hue("creator_label",drop=FALSE)+
  theme(axis.title.y=element_blank(),legend.title=element_blank(), legend.position="none")
zoom2<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2017, edon==19) %>% 
   ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.2,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+
    scale_color_hue("creator_label",drop=FALSE)+
  theme(axis.title.y=element_blank(),legend.title=element_blank(), 
        strip.background = element_rect(fill=alpha("blue",.3)),)
ggarrange(zoom1,zoom2,ncol=2)
rm(zoom1,zoom2) 

```

```{r fig.width=10, fig.height=10}
#plots
pl1<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2013, edon<16) %>% 
  ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid)) +geom_point()+geom_line()+geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+theme(legend.position = "none") +
    scale_color_hue("creator_label",drop=FALSE)
pl2<-planProp.df %>% filter(VALIDPLAN)  %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2017, edon<16) %>% 
   ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y") + theme(legend.position = "none", axis.title.y=element_blank(), strip.background =element_rect(fill=alpha("blue",.3)))+
    scale_color_hue("creator_label",drop=FALSE)
pl3<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2013, edon>=16) %>% 
  ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid)) +geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+theme(legend.position = "none",axis.title.y=element_blank()) +
    scale_color_hue("creator_label",drop=FALSE)
pl4<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2017, edon>=16) %>% 
   ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.2,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+theme(axis.title.y=element_blank(), legend.title=element_blank(),
strip.background =element_rect(fill=alpha("blue",.3))) +
    scale_color_hue("creator_label",drop=FALSE)
ggarrange(pl1,pl2,pl3,pl4,ncol=4)
rm(pl1,pl2,pl3,pl4)
```
```{r fig.width=10, fig.height=2}
#Pull out edon == 11 (Gua) for map analysis
ex_11_13 <- planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2013, edon==11) %>% 
  ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid)) +geom_point()+geom_line()+geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+theme(legend.position = "none") +
    scale_color_hue("creator_label",drop=FALSE)
ex_11_17 <- planProp.df %>% filter(VALIDPLAN)  %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2017, edon==11) %>% 
   ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y") + theme(axis.title.y=element_blank(), strip.background =element_rect(fill=alpha("blue",.3)))+
    scale_color_hue("creator_label",drop=FALSE)
ggarrange(ex_11_13, ex_11_17, ncol=2)
rm(ex_11_13, ex_11_17)

```

## Algorithmic Score Efficency 
```{r, best-scoring}
efficiency.df <- contestSum.df %>% rowwise() %>% mutate(efficiency=(1-(phase1_start-lowestvalid)/lowestvalid)*100) %>% select(year,edon,efficiency) %>% mutate(year=as.factor(year))
efficiency.df %>% group_by(year) %>% summarize(min_efficiency=min(efficiency),median_efficiency=median(efficiency), mean_efficiency=mean(efficiency))
efficiency.df %>% ggplot(aes(efficiency))+geom_histogram(bins=30)+facet_grid(rows=vars(year))
efficiency.df %>% ggplot(aes(x=edon,y=efficiency,fill=year))+geom_col(position="dodge", width=.5)
rm(efficiency.df)

planProp.df %>% filter(best_plan) %>% 
  group_by(creator_coded,year) %>% summarise(count=n(),percent=count/32) %>% 
ungroup() %>%
  left_join(by=c("creator_coded"="actor"),actors.df) %>%
  mutate( actortype=case_when(
    as.character(creator_coded)=="ALGORITHM" ~ "admin",
    as.character(creator_coded)=="Coalition" ~ "multiple",
        as.character(creator_coded)=="UNANIMOUS" ~ "multiple",
    TRUE ~ as.character(actortype)
  )) %>%
  pivot_wider(names_from="year", values_from=c("count","percent"),values_fill=0) %>%
  relocate(count_2013,percent_2013,count_2017,percent_2017) %>%
  group_by(actortype) %>%
  gt(rowname_col="creator_coded") %>%
   tab_header(title="Best Scoring Plans by Creator") %>%
   cols_label( "creator_coded" = "Actor", "count_2013"="Best", "percent_2013"="",
               "count_2017"="Best","percent_2017"="") %>%
  tab_spanner(columns=c("count_2013","percent_2013"),label="2013") %>%
    tab_spanner(columns=c("count_2017","percent_2017"),label="2017") %>%

    fmt_percent(columns=starts_with("percent")) %>%
  data_color (
       columns=starts_with("percent"), 
       colors = scales::col_numeric( 
       palette = c( "white","red"), 
         domain = c(0,1) ) 
     ) %>% 
   tab_source_note(
    source_note = "Note: Creators refers to initial plan creators, others may have joined in later rounds." ) %>%
  gt_theme_538() 


```
## Exceptional Events 
```{r}
res_events_grp.df <-
  planProp.df %>% group_by(year) %>% summarise(
      events = sum( !VALIDPLAN ) , 
      denominator = n(), type = "INE Invalidated Proposed Plan" , category="compliance"
  )

res_events_grp.df %<>% bind_rows(
   contestSum.df %>% group_by(year) %>% summarise(
      events = sum(final_section8) + sum(phase2_section8) , 
      denominator = n()*2, type = "Unanimous Higher Score Proposal Accepted" , category="compliance"
  )
)

res_events_grp.df %<>% bind_rows(
  contestSum.df %>% group_by(year) %>% summarise(
      events = sum(INEchanged_phase3) + sum(INEchanged_final) , 
      denominator = n()*2, type = "INE Modified proposals" , category="compliance"
  )
)

res_events_grp.df %<>% bind_rows(
  contestSum.df %>% 
  rowwise () %>% 
  mutate ( adminplans=(length(phase2_plans)-length(phase2_plans_party)) +
                           (length(phase4_plans)-length(phase4_plans_party))) %>% 
     group_by(year) %>% summarise(
      events = sum(adminplans)  , 
      denominator = n()*2, type = "INE Added proposals" , category="compliance"
  )
)

res_events_grp.df %<>% bind_rows(
  contestSum.df %>% group_by(year) %>% summarise(
      events = sum(phase2_violation) + sum(final_violation) , 
      denominator = n()*2, type = "Higher Score Plan Without Unanimity" , category="compliance"
  )
)



res_events_grp.df %>% group_by(year) %>% summarize(
  type=type, 
  count=events,
  percent=count/denominator,
  ) %>%
  pivot_wider(names_from=year,values_from=c(count,percent))%>%
  relocate(type,count_2013,percent_2013,count_2017,percent_2017) %>%
  gt() %>%
    cols_label( percent_2013="" , percent_2017="", "type"="","count_2013"="","count_2017"="") %>%
    fmt_percent(columns=c("percent_2013","percent_2017")) %>%
    tab_header(title="Process Exceptions") %>%
    tab_spanner(
      label = "2013",
      columns = vars(count_2013, percent_2013)
    ) %>%
    tab_spanner(
      label = "2017",
      columns = vars(count_2017, percent_2017)
    ) %>%
    tab_source_note( source_note = "Note: Exceptions are suspect, but not necessarily illegal." ) %>%
    data_color (
      columns = vars(percent_2013,percent_2017), 
      colors = scales::col_numeric( 
      palette = c( "white","orange"), 
        domain = c(0,.25) ) 
    ) %>% 
    gt_theme_538() 
```

## Outcome vs Expectations
- Best score won
- Algorithm won
- Lower score won without unanimity
- Section 8 won
```{r}
contestSum.df %>% group_by(year) %>%     
  summarize( 
    best_lost = sum(best_lost)/n(),
    algorithm_lost = sum(final_win!=phase1_start)/n(),
    section8_won = sum(final_section8)/n(),
    rules_violation = sum(final_violation)/n(),
  ) %>% group_by(year) %>%
 gt() %>%
    cols_label( algorithm_lost= "Algorithm  Lost", best_lost="Best Score Lost", 
                section8_won="Unanimous - Not Best", rules_violation="No Agreement & Not Best") %>%
    fmt_percent(2:5) %>%
    tab_header(title="Unexpected Winners") %>%
    tab_source_note( source_note = "Note:N=32 per year." ) %>%
    data_color (
      columns=2:5, 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,1) ) 
    ) %>% 
    gt_theme_538() 

planProp.df %>% filter(win_final) %>% 
  group_by(creator_coded,year) %>% summarize(wins=n(),percent=wins/32) %>% 
  ungroup() %>%
  left_join(by=c("creator_coded"="actor"),actors.df) %>%
  mutate( actortype=case_when(
    as.character(creator_coded)=="ALGORITHM" ~ "admin",
    as.character(creator_coded)=="Coalition" ~ "multiple",
        as.character(creator_coded)=="UNANIMOUS" ~ "multiple",
    TRUE ~ as.character(actortype)
  )) %>%
  pivot_wider(names_from="year", values_from=c("wins","percent"),values_fill=0) %>%
  relocate(wins_2013,percent_2013,wins_2017,percent_2017) %>%
  group_by(actortype) %>%
  gt(rowname_col="creator_coded") %>%
   tab_header(title="Winning Plans by Creator") %>%
   cols_label( "creator_coded" = "Actor", "wins_2013"="wins", "percent_2013"="",
               "wins_2017"="wins","percent_2017"="") %>%
  tab_spanner(columns=c("wins_2013","percent_2013"),label="2013") %>%
    tab_spanner(columns=c("wins_2017","percent_2017"),label="2017") %>%

    fmt_percent(columns=starts_with("percent")) %>%
  data_color (
       columns=starts_with("percent"), 
       colors = scales::col_numeric( 
       palette = c( "white","red"), 
         domain = c(0,1) ) 
     ) %>% 
  tab_source_note(
    source_note = "Note: Creators refers to initial plan creators, others may have joined in later rounds." ) %>%
  gt_theme_538()


```

## Exceptions by party
```{r}

res_outcomes_party.df <-
  planProp.df %>% group_by(year,creator_coded) %>% summarise(
      events = sum( !VALIDPLAN ) , 
      denominator = n(), type = "Invalidated" , category="compliance"
  )

# Not enough variation with coalitions... move this to a proportion/network analysis
# note denominator is number of contests in each year
#res_outcomes_party.df %<>% bind_rows(
#    planProp.df %>% group_by(year,creator_coded) %>% summarise(
#      events = sum( win_section8 ) , 
#      denominator = 32, type = "Won w Sec8" , category="compliance"
# )
#)

res_outcomes_party.df %<>% bind_rows(
    planProp.df %>% group_by(year,creator_coded) %>% summarise(
      events = sum( win_violation ) , 
      denominator = 32, type = "WinViolation" , category="compliance"
  )
)

res_outcomes_party.df %<>% rowwise() %>% mutate(percent=events/denominator)

res_outcomes_party.df %>% 
  group_by(year,creator_coded) %>% relocate(type) %>% select(-denominator,-category) %>%
    filter(sum(events)>0) %>%
    ungroup() %>%
    left_join(by=c("creator_coded"="actor"),actors.df) %>%
   mutate( actortype=case_when(
    as.character(creator_coded)=="ALGORITHM" ~ "admin",
    as.character(creator_coded)=="Coalition" ~ "multiple",
        as.character(creator_coded)=="UNANIMOUS" ~ "multiple",
    TRUE ~ as.character(actortype)
  )) %>%
    pivot_wider(names_from=c("year","type"), values_from=c("events","percent"),values_fill=0) %>%
  relocate(creator_coded, 
           events_2013_Invalidated,percent_2013_Invalidated,
           events_2017_Invalidated,percent_2017_Invalidated,
           events_2013_WinViolation,percent_2013_WinViolation,
           events_2017_WinViolation,percent_2017_WinViolation,
           ) %>%
      group_by(actortype) %>%
  gt(rowname_col="creator_coded") %>%
    cols_label( events_2013_Invalidated = "2013", 
                events_2017_Invalidated = "2017",
                events_2013_WinViolation = "2013",
                events_2017_WinViolation = "2017",
                percent_2013_Invalidated = "", 
                percent_2017_Invalidated = "",
                percent_2013_WinViolation = "",
                percent_2017_WinViolation = "",
                ) %>%
    tab_header(title="Exceptions by Creator") %>%
    tab_source_note( source_note = "Note: Denominator for wins is 32 states/year. Denominator for invalidations is total proposals by that party." ) %>%
 fmt_percent(columns=starts_with("percent")) %>%
  data_color (
       columns=starts_with("percent"), 
       colors = scales::col_numeric( 
       palette = c( "white","red"), 
         domain = c(0,.2) ) 
     ) %>%
    tab_spanner(columns=c("events_2013_WinViolation",
                          "percent_2013_WinViolation",
                          "events_2017_WinViolation",
                          "percent_2017_WinViolation"
                         ) , label="Won in Violation of Rules") %>%
    tab_spanner( columns=c("events_2013_Invalidated", 
                          "percent_2013_Invalidated",
                          "events_2017_Invalidated",
                          "percent_2017_Invalidated" ),
                           label="Invalidated") %>%
    gt_theme_538() 



```

## Disaggregated Analysis
```{r}
unrolled.df <-planProp.df  %>% unnest(creators)

ncontests <- 32
res_outcomes_unrolled.df <- 
  unrolled.df %>% 
  filter(win_final) %>% 
  mutate(denominator=ncontests) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Win", denominator=unique(denominator) )

res_outcomes_unrolled.df %<>% bind_rows(
  unrolled.df %>% 
  mutate(denominator=ncontests) %>% 
  filter(win_section8) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Win by sec 8", denominator=unique(denominator) )
)

res_outcomes_unrolled.df %<>% bind_rows(
  unrolled.df %>% 
  mutate(denominator=ncontests) %>% 
  filter(win_violation) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Win in violation of the rules", denominator=unique(denominator) )
)

res_outcomes_unrolled.df %<>% bind_rows(
  unrolled.df %>% 
  group_by(year) %>% mutate(denominator=length(unique(planid))) %>% 
  filter(!VALIDPLAN) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Invalidated", denominator=unique(denominator) )
)

res_outcomes_unrolled.df %<>% rowwise() %>% mutate(percent=events/denominator)

res_outcomes_unrolled.df %>% 
  rowwise() %>% filter(type=="Win") %>%
  group_by(year,creators) %>% relocate(type) %>% select(-denominator) %>%
    filter(sum(events)>0) %>%
    gt() %>% 
    cols_label( percent="%","events"="" ) %>%
    fmt_percent(columns="percent") %>%
    tab_header(title="Wins by Invidual Creator") %>%
    tab_source_note( source_note = "Note: Percentages do not add up to 100% because plans have multiple creators. Denominator for win measures is 32/year. Denominator for invalidations is total proposals in that year." ) %>%
    data_color (
      columns = vars(percent), 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,.8) ) 
    ) %>% 
    gt_theme_538() 

res_outcomes_unrolled.df %>% 
  rowwise() %>% filter(type!="Win") %>%
  group_by(year,creators) %>% relocate(type) %>% select(-denominator) %>%
    filter(sum(events)>0) %>%
    gt() %>% 
    cols_label( percent="%","events"="" ) %>%
    fmt_percent(columns="percent") %>%
    tab_header(title="Exceptions by Invidual Creator") %>%
    tab_source_note( source_note = "Note: Percentages do not add up to 100% because plans have multiple creators. Denominator for win measures is 32/year. Denominator for invalidations is total proposals in that year." ) %>%
    data_color (
      columns = vars(percent), 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,.8) ) 
    ) %>% 
    gt_theme_538()




```
##  Exploratory Network Analysis
```{r fig.width=10, fig.height=4}
require(DiagrammeR)
require(tidygraph)
require(igraph)
require(ggraph)


actorsnodes.df <- actors.df  %>% filter(!actor %in% c("Junta","derfe","CLV","PRD51")) %>% mutate(id=1:n()) %>% mutate(label=actor) %>% relocate(id,label)
actorsedges.df <-planProp.df %>% select(planid, creators, win_final, win_section8, win_violation, VALIDPLAN) %>% unnest(creators)
actorsedges.df %<>% left_join(actorsnodes.df,by=c("creators"="actor")) %>% select(-label,-actortype) %>% rename("creator_id"="id")
actorsedges.df %<>% left_join(actorsedges.df %>% select(planid,creator_id), by="planid") %>% 
  rename("from"="creator_id.x","to"="creator_id.y") 
actorsedges.df %<>%  
  filter(to!=from) %>%  
  mutate (id=1:n() , 
          weight = ifelse(win_final,1,.5),
          color = ifelse(win_final,"red","black"),
          rel = ifelse(win_final,"win","lose") 
          ) %>%
  relocate(id,to,from,weight,color,rel)
    

plan.graph <-create_graph( nodes_df= actorsnodes.df, edges_df = actorsedges.df, graph_name="Actors Proposing Together")

#plan.graph %>% render_graph(layout="circle")
# can also use this an igraph or tidygraph object
plan.igraph <- to_igraph(plan.graph)
plan.tgraph <- as_tbl_graph(plan.igraph)
plan.tgraph %>% ggraph() +
    geom_edge_fan(aes(color=factor(rel)),alpha=.2) +
    #geom_edge_density(fill="blue") +
  geom_node_label(aes(label=actor,color=factor(actortype)))

```
Seat Outcomes Based on INE Vote/District Tables
(Source: INE 2015 [https://web.archive.org/web/20151119052818/http://computos2015.ine.mx/Nacional/VotosPorPartido/])
(Source: INE 2018 [https://computos2018.ine.mx/#/diputaciones/nacional/1/3/1/1])
```{r}
Outcome_15 <- data.frame(actor = c("MORENA", "PAN", "PRI", "PRD", "PVEM", "MC", 
                                   "PT", "PNA", "ES", "PH", "PRI-PVEM", "PRD-PT", "Independent"),
                         seats = c( 14, 55, 25, 5, 0, 10, 0, 1, 0, 0, 160, 29, 1))
Outcome_18 <- data.frame(actor = c("MORENA", "PAN", "PRI", "PRD", "PVEM", "MC", 
                                   "PT", "PNA", "ES", "MORENA-PT-ES", "PAN-PRD-MC", "PRI-PVEM-PNA"),
                         seats = c(8, 5, 1, 0, 0, 0, 0, 0, 0, 210, 63, 13))
```

#Outcome Analysis
```{r}
source("PrepSeatScores.R",verbose=FALSE)
```

```{r}
planFull.df <- left_join(planProp.df,planProcessing.df %>% select(-plan_2015,-plan_2012,-plan_2018))
planFull.df %<>% mutate(plan_2018_actors_winMargins_compCount=plan_2018_actors_winMargins_compCount2, 
                        plan_2015_actors_winMargins_compCount=plan_2015_actors_winMargins_compCount2,
                        plan_2012_actors_winMargins_compCount=plan_2012_actors_winMargins_compCount2)
# add reapportionment flag
reapportionedEdons <- c (7, 9, 11, 14, 15, 20, 21, 22, 23, 25, 28, 30)
planFull.df %<>% rowwise() %>% mutate(reapportioned = edon %in% reapportionedEdons) %>% ungroup
```
Competitive plan analysis
By Year
```{r, strategy-table-5}
# strategy table 5

makeCompetivenessTable<-function(margin=2) {
  comp.tbl <- NULL
  v2015 = str2lang(paste0("plan_2015_actors_winMargins_compCount",margin))
  v2018 = str2lang(paste0("plan_2018_actors_winMargins_compCount",margin)) 
  comp.tbl %<>% bind_rows(
    planFull.df %>% filter(win_final) %>% 
      group_by(year) %>% 
      summarize(
        scenario="winner",
        comp_2015=sum( {{v2015}} ,na.rm=TRUE), 
        comp_2018=sum( {{v2018}} ,na.rm=TRUE), 
      )
  )
  
  comp.tbl %<>% bind_rows(
    planFull.df %>% filter(best_nonmissing) %>%
      group_by(year) %>%
      summarize(
        scenario="best",
        comp_2015=sum(  {{v2015}} ,na.rm=TRUE),
        comp_2018=sum(  {{v2018}} ,na.rm=TRUE),
      )
  )

  comp.tbl %<>% bind_rows(
    planFull.df %>% filter(first_appeared==1) %>%
      group_by(year) %>%
      summarize(
        scenario="algorithm",
        comp_2015=sum( {{v2015}} ,na.rm=TRUE),
        comp_2018=sum( {{v2018}} ,na.rm=TRUE)
      )
  )

  comp.tbl %<>% bind_rows(
    planProcessing.df %>% filter(str_starts(planid,"base")) %>%
      mutate(year=2004) %>%
      group_by(year) %>%
      summarize(
        scenario="status quo",
        comp_2015=sum( {{v2015}} ,na.rm=TRUE),
        comp_2018=sum( {{v2018}} ,na.rm=TRUE)
      )
  )
  
  comp.tbl %>% mutate(margin=margin)
  

}


cmp2.tbl %>% group_by(year) %>% gt() %>% 
  cols_hide("margin")


makeCompetivenessTable(margin=2) %>% 
  group_by(year) %>% gt() %>% cols_hide("margin") %>% tab_header("Competitive Seats under Multiple scenarios") %>% tab_source_note(paste0("Margin = ",2,"%"))

makeCompetivenessTable(margin=4) %>% 
  group_by(year) %>% gt() %>% cols_hide("margin") %>% tab_header("Competitive Seats under Multiple scenarios") %>% tab_source_note(paste0("Margin = ",4,"%"))

makeCompetivenessTable(margin=4) %>% 
  group_by(year) %>% gt() %>% cols_hide("margin") %>% tab_header("Competitive Seats under Multiple scenarios") %>% tab_source_note(paste0("Margin = ",8,"%"))


```
Competitive plan analysis
By Year
```{r, competitive-by-party}
# strategy table 6
comp.tbl <- NULL
comp.tbl %<>% bind_rows(
  planFull.df %>% filter(win_final) %>% 
  group_by(year, creator_coded) %>% 
  summarize(
    scenario="winner",
    comp_2015=sum(plan_2015_actors_winMargins_compCount,na.rm=TRUE), 
    comp_2018=sum(plan_2018_actors_winMargins_compCount,na.rm=TRUE), 
  )
)
comp.tbl %<>% bind_rows(
  planFull.df %>% filter(best_nonmissing) %>% 
  group_by(year, creator_coded) %>% 
  summarize(
    scenario="best",
    comp_2015=sum(plan_2015_actors_winMargins_compCount,na.rm=TRUE), 
    comp_2018=sum(plan_2018_actors_winMargins_compCount,na.rm=TRUE), 
  )
)

comp.tbl %<>% bind_rows(
  planFull.df %>% filter(first_appeared==1) %>% 
  group_by(year, creator_coded) %>% 
  summarize(
    scenario="algorithm",
    comp_2015=sum(plan_2015_actors_winMargins_compCount,na.rm=TRUE), 
    comp_2018=sum(plan_2018_actors_winMargins_compCount,na.rm=TRUE)
  )
)

comp.tbl %<>% bind_rows(
  planProcessing.df %>% filter(str_starts(planid,"base")) %>% 
    mutate(year=2004) %>%
   group_by(year) %>% 
  summarize(
    scenario="status quo",
    comp_2015=sum(plan_2015_actors_winMargins_compCount,na.rm=TRUE), 
    comp_2018=sum(plan_2018_actors_winMargins_compCount,na.rm=TRUE)
  )
)

comp.tbl %>% group_by(year,creator_coded) %>% filter(creator_coded != "ALGORITHM") %>% filter(year == 2013) %>% gt()
comp.tbl %>% group_by(year,creator_coded) %>% filter(creator_coded != "ALGORITHM") %>% filter(year == 2017) %>% gt()

```


Party seat analysis
```{r, strategy-table-2}

# strategy table 2
seats.tbl <- NULL
seats.tbl %<>% bind_rows(
  planFull.df %>% filter(win_final) %>% group_by(year) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="winner")
)
seats.tbl %<>% bind_rows(
  planFull.df %>% filter(win_final) %>% group_by(year) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="winner")
)
seats.tbl %<>% bind_rows(
  planFull.df %>% filter(best_nonmissing) %>% group_by(year) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="best")
)
seats.tbl %<>% bind_rows(
  planFull.df %>% filter(best_nonmissing) %>% group_by(year) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="best")
)
seats.tbl %<>% bind_rows(
  planFull.df %>% filter(first_appeared==1) %>% group_by(year) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="algorithm")
)
seats.tbl %<>% bind_rows(
  planFull.df %>% filter(first_appeared==1) %>% group_by(year) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="algorithm")
)

seats.tbl %<>% bind_rows(
  planProcessing.df %>% filter(str_starts(planid,"base")) %>% 
  tidyr::crossing(year=c(2013,2017)) %>%
   group_by(year) %>% 
   summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
   unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
  rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="status quo")
)

seats.tbl %<>% bind_rows(
  planProcessing.df %>% filter(str_starts(planid,"base")) %>% 
  tidyr::crossing(year=c(2013,2017)) %>%
   group_by(year) %>% 
   summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
   unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
  rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="status quo")
)


seats.tbl %>% pivot_wider(names_from=scenario,values_from=seats,values_fill=0 ) %>% group_by(year,year_elec) %>% gt()
```



```{r mexico-state-gerrymandering}
# strategy table 4
seats_mex.tbl <- NULL
seats_mex.tbl %<>% bind_rows(
  planFull.df %>% filter(win_final) %>% 
    filter(edon==15) %>%
    group_by(year) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="winner")
)
seats_mex.tbl %<>% bind_rows(
  planFull.df %>% filter(win_final) %>%
    filter(edon==15) %>%
    group_by(year) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="winner")
)

seats_mex.tbl %<>% bind_rows(
  planFull.df %>% filter(first_appeared==1) %>% 
    filter(edon==15) %>%
    group_by(year) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="algorithm")
)
seats_mex.tbl %<>% bind_rows(
  planFull.df %>% filter(first_appeared==1) %>% 
    filter(edon==15) %>%
    group_by(year) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="algorithm")
)

seats_mex.tbl %<>% bind_rows(
  planProcessing.df %>% filter(str_starts(planid,"base")) %>% 
  filter(edon==15) %>%
  tidyr::crossing(year=c(2013,2017)) %>%
   group_by(year) %>% 
   summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
   unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
  rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="status quo")
)

seats_mex.tbl %<>% bind_rows(
  planProcessing.df %>% filter(str_starts(planid,"base")) %>%
    filter(edon==15) %>%
  tidyr::crossing(year=c(2013,2017)) %>%
   group_by(year) %>% 
   summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
   unnest(c(results,year)) %>% group_by(year) %>% count(win_actor) %>%
  rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="status quo")
)

## find best of the academic plans

 academic_2018.tbl <- planProcessing.df %>% filter(str_starts(planid,"academic-pri")) %>% 
    filter(edon==15) %>% 
    select(planid,plan_2018_actors_winMargins) %>% 
    unnest(plan_2018_actors_winMargins) %>% 
    group_by(planid,win_actor) %>%
    count() %>% ungroup
  
  best_2018 <- academic_2018.tbl %>% group_by(planid) %>%
    mutate(PRI_SEATS=n[which(win_actor=="PRI")]) %>% 
    ungroup %>%
    arrange(desc(PRI_SEATS)) %>% 
    slice_head %>% select(planid) %>% pull
 
  seats_mex.tbl %<>% bind_rows(
  academic_2018.tbl %>% filter(planid==best_2018) %>% 
    rename(actor="win_actor",seats=n) %>%
    select(-planid) %>%
    mutate(year_elec=2018,scenario="academic") %>%
    tidyr::crossing(year=c(2013,2017))
  )
  
   academic_2015.tbl <- planProcessing.df %>% filter(str_starts(planid,"academic-pri")) %>% 
    filter(edon==15) %>% 
    select(planid,plan_2015_actors_winMargins) %>% 
    unnest(plan_2015_actors_winMargins) %>% 
    group_by(planid,win_actor) %>%
    count() %>% ungroup
  
  best_2015 <- academic_2015.tbl %>% group_by(planid) %>%
    mutate(PRI_SEATS=n[which(win_actor=="PRI")]) %>% 
    ungroup %>%
    arrange(desc(PRI_SEATS)) %>% 
    slice_head %>% select(planid) %>% pull
 
  seats_mex.tbl %<>% bind_rows(
  academic_2015.tbl %>% filter(planid==best_2015) %>% 
    rename(actor="win_actor",seats=n) %>%
    select(-planid) %>%
    mutate(year_elec=2015,scenario="academic") %>%
    tidyr::crossing(year=c(2013,2017))
)

seats_mex.tbl %>%
  pivot_wider(names_from=scenario,values_from=seats,values_fill=0 ) %>%
  group_by(year,year_elec) %>% 
  gt() %>%
    tab_header(title="Mexico State -- Comparing Party Plans &  Academic Gerrymandering Excercise") %>%
    gt_theme_538()



```


#State Seat Analysis
```{r}
edon.tbl <- NULL
edon.tbl %<>% bind_rows(
  planFull.df %>% filter(win_final) %>% group_by(year, edon) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year, edon) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="winner")
)
edon.tbl %<>% bind_rows(
  planFull.df %>% filter(win_final) %>% group_by(year, edon) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year, edon) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="winner")
)

edon.tbl %<>% bind_rows(
  planFull.df %>% filter(best_nonmissing) %>% group_by(year, edon) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year, edon) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="best")
)
edon.tbl %<>% bind_rows(
  planFull.df %>% filter(best_nonmissing) %>% group_by(year, edon) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year, edon) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="best")
)
edon.tbl %<>% bind_rows(
  planFull.df %>% filter(first_appeared==1) %>% group_by(year, edon) %>%
    summarize(results=list(bind_rows(plan_2015_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year, edon) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2015, scenario="algorithm")
)
edon.tbl %<>% bind_rows(
  planFull.df %>% filter(first_appeared==1) %>% group_by(year, edon) %>%
    summarize(results=list(bind_rows(plan_2018_actors_winMargins))) %>%
    unnest(c(results,year)) %>% group_by(year, edon) %>% count(win_actor) %>%
    rename(actor=win_actor,seats=n) %>% mutate(year_elec=2018, scenario="algorithm")
)

edon.tbl %>% pivot_wider(names_from=scenario,values_from=seats,values_fill=0) %>% group_by(year,year_elec,edon) %>%
             filter(year_elec == 2015 & year == 2013) %>% gt()
edon.tbl %>% pivot_wider(names_from=scenario,values_from=seats,values_fill=0) %>% group_by(year,year_elec,edon) %>%
             filter(year_elec == 2018 & year == 2017) %>% gt()
```

# party plans
```{r, strategy-table-3}
# strategy table 3
planseats_2018.df <- planFull.df %>% rowwise() %>% filter(!is.null(plan) & VALIDPLAN) %>% unnest(plan_2018_actors_winMargins_actorWins) %>% select(planid,edon,year,win_actor,n) %>% rename(actor=win_actor,seats=n)

planseats_2015.df <- planFull.df %>% rowwise() %>% filter(!is.null(plan) & VALIDPLAN) %>% unnest(plan_2015_actors_winMargins_actorWins) %>% select(planid,edon,year,win_actor,n) %>% rename(actor=win_actor,seats=n)

actor_best.tbl = NULL

for (i in c("MORENA","MC","PAN","PRI","PRD")) {

actor_best.tbl %<>% bind_rows(
planseats_2018.df %>% filter(actor=={{ i }}) %>% group_by(edon) %>% slice_max(seats) %>% slice_head(n=1) %>% ungroup() %>% summarize( actor=unique(actor), seats=sum(seats),type="max", year=2018)
)
  
actor_best.tbl %<>% bind_rows(
planseats_2015.df %>% filter(actor=={{ i }}) %>% group_by(edon) %>% slice_max(seats) %>% slice_head(n=1) %>% ungroup() %>% summarize( actor=unique(actor),type="max", seats=sum(seats), year=2015)
)

actor_best.tbl %<>% bind_rows(
planseats_2018.df %>% filter(actor=={{ i }}) %>% group_by(edon) %>% slice_min(seats) %>% slice_head(n=1) %>% ungroup() %>% summarize( actor=unique(actor), type="min", seats=sum(seats), year=2018)
)

  
actor_best.tbl %<>% bind_rows(
planseats_2015.df %>% filter(actor=={{ i }}) %>% group_by(edon) %>% slice_min(seats) %>% slice_head(n=1) %>% ungroup() %>% summarize( actor=unique(actor), type="min",seats=sum(seats), year=2015)
)


}

actor_best.tbl %>%
  pivot_wider(names_from=type,values_from=seats) %>%
  group_by(year) %>%
  gt()
  

```
#Uniform swing analysis
```{r uniform-swing}


uniform_shift_from<- function(iplans, act_1="PRI",act_2="MORENA",shift_bound=(1/3),slices=50) {
  
vote_shifts = seq(0,shift_bound,length=slices)
  
 tp <- iplans %>%
  select(edon,plan_2015_actors_winMargins) %>% 
  unnest(cols = c(plan_2015_actors_winMargins)) %>%
  select(edon,district,votes_share,actor) %>%
  rowwise() %>% 
  unnest(cols=c(votes_share,actor))
 
 # fill in missing 2nd actor
  ue <- tp %>% group_by(edon,district) %>% summarize(actor=act_2,votes_share=0)
  tp %<>% bind_rows (ue %>% anti_join(tp,by=c("actor","edon","district")))


  shift_it <- function(vote_shift) {
    tp %>%
      group_by(edon,district) %>% 
      mutate(
        shift_size = ifelse( length(which(actor==act_1)>0),votes_share[which(actor==act_1)],0) * vote_shift 
      ) %>% 
      rowwise() %>%
      mutate(vote_share_new = case_when(
        actor == act_1 ~  votes_share - shift_size,
        actor == act_2  ~ votes_share + shift_size,
        TRUE ~ votes_share
      )) %>% select (-shift_size) %>% 
       group_by(edon,district) %>% 
       slice_max(vote_share_new) %>% 
       ungroup() %>% 
       select(actor) %>% 
       count(actor) %>%
       mutate(shift=vote_shift)
  }
  
  map_dfr(vote_shifts,shift_it) 

}


swing_alg.tbl <- uniform_shift_from( 
  planFull.df %>%   filter(first_appeared==1, year=="2017") ,
  shift_bound=1, slices=100) %>% mutate(scenario="algorithm")

swing_sq.tbl <- uniform_shift_from( 
  planProcessing.df %>% filter(str_starts(planid,"base")),
  shift_bound=1, slices=100)  %>% mutate(scenario="status quo")

swing_win.tbl <- uniform_shift_from( 
  planFull.df %>% filter(year==2017,win_final==TRUE), 
  shift_bound=1, slices=100) %>% mutate(scenario="winner")

swing_all.tbl <- bind_rows(swing_alg.tbl,swing_sq.tbl,swing_win.tbl) %>%
  mutate(actor=factor(actor))
                           
pl1 <- swing_all.tbl %>% 
  filter(scenario=="status quo") %>%
  ggplot(aes(x=shift,y=n,group=actor,color=actor)) +
  geom_line() + 
  scale_y_continuous(limits=c(0,220))+
  labs(title="2004 Status Quo Plan Under a Partisan Swing",
       caption = "(Models uniform swing from 2015 PRI returns to Morena.)", y="Seats", x="Swing")
                           
pl2<- swing_all.tbl %>% 
  filter(scenario=="algorithm") %>%
  ggplot(aes(x=shift,y=n,group=actor, color=actor)) +
  geom_line() + 
  scale_y_continuous(limits=c(0,220))+
  labs(title="2017 Algorithmic Plan Under a Partisan Swing",
          caption = "(Models uniform swing from 2015 PRI returns to Morena.)", y="Seats", x="Swing")

pl3<- swing_all.tbl %>% 
  filter(scenario=="winner") %>%
  ggplot(aes(x=shift,y=n,group=actor,color=actor)) +
  geom_line() + 
  scale_y_continuous(limits=c(0,220))+
  labs(title="2017 Winning Plan Under a Partisan Swing",
       caption = "(Models uniform swing from 2015 PRI returns to Morena.)", y="Seats", x="Swing")

pl4<- swing_all.tbl %>% 
  filter(actor=="PRI") %>%
  ggplot(aes(x=shift,y=n,group=scenario,color=scenario)) +
  geom_line() + 
  scale_y_continuous(limits=c(0,200))+
  labs(title="2017 PRI Under a Partisan Swing - Scenario Comparison",
       caption = "(Models uniform swing from 2015 PRI returns to Morena.)", y="Seats", x="Swing") 

plot(pl1/pl2/pl3/pl4)


```
#District Change Analysis
## Total Change vs. 2004 baseline
```{r change-v-baseline}
library("ggside")

basediffs.tbl <- planFull.df %>% 
  filter(VALIDPLAN) %>%
  group_by(year, edon) %>% 
  summarise(
  reapportioned=head(reapportioned,n=1),
  baseline_change = mean(base_diff_percent,na.rm=TRUE),
  tla=head(tla,n=1)
  )

basediffs.tbl %>% 
  ggplot(aes(x=edon,y=baseline_change, color=reapportioned)) +
  geom_point() + 
  geom_segment( aes(x=edon, xend=edon, y=0, yend=baseline_change)) + 
   geom_ysidehistogram(aes(x=stat(density),fill=reapportioned),alpha=.2) +
  facet_wrap(vars(year)) +
  labs(title="Change in Seccion Assignment: Proposals vs. 2004 Baseline",
       caption = "(Mean  proposed plans in edon & year.)", y="Proportion Changed", x="Edon", color="apportionment change", fill="apportionment change")
  

```
## Total Change vs. Algorithmic  proposal
```{r change-v-algorithm-proposal}

  
local({
  algplan.tbl <- planFull.df %>% filter(first_appeared==1)  %>% select(planid,plan,year,edon)

diffAlg_<-function(plan,i,j) {
  aplan <- algplan.tbl %>% filter(edon==i, year==j)  %>% pull(plan)
  planDiff(plan,aplan[[1]])
}
  diffAlg_}) -> diffAlg

nonalgPlans.tbl <- planFull.df %>% 
  rowwise() %>%
  filter(VALIDPLAN) %>% 
  filter(first_appeared>1) %>%
  filter(!is.null(plan)) %>%
  ungroup()

nonalgPlans.tbl %<>% 
  rowwise() %>%
  mutate(alg_diffs=list(diffAlg(plan,edon,year))) %>%
  mutate(
  alg_diff_sum=sum(alg_diffs$size),
  alg_diff_delta = head(alg_diffs$deltadist,n=1),
  alg_diff_percent = alg_diff_sum/plansize,
  ) %>%
  ungroup()

planFull.df %>% 
  filter(first_appeared==1) %>%
  ggplot(aes(x=edon,y=base_diff_percent,color=reapportioned)) +
  geom_point() + 
  geom_segment( aes(x=edon, xend=edon, y=0, yend=base_diff_percent))  +
 geom_ysidehistogram(aes(x=stat(density), fill="(Total)", color="(Total)"))+
  facet_wrap(vars(year))  +
  labs(title="Change in Seccion Assignment: Algorithmic Plan vs. 2004 Baseline",  caption = "", y="Proportion Changed", x="Edon", color="apportionment change")

nonalgPlans.tbl %>% filter(win_final) %>% 
  ggplot(aes(x=edon,y=alg_diff_percent,color=creator_label,fill=creator_label)) +
  geom_point() + 
  geom_segment( aes(x=edon, xend=edon, y=0, yend=alg_diff_percent)) + 
  facet_wrap(vars(year)) + 
     geom_ysidehistogram(aes(x=stat(density), fill="(Total)", color="(Total)")) +
 labs(title="Change in Seccion Assignment: Winning Plan vs. Algorithmic proposal",
       caption = "", y="Proportion Changed", x="Edon", color="creator",fill="creator")

library("ggh4x")


nonalgPlans.tbl %>% 
  ggplot(aes(x=edon,y=alg_diff_percent, color=as.factor(creator_label))) +
  geom_point() + 
  facet_nested(rows=(vars(year)) , cols=(vars(first_appeared)) ) +
   labs(title="Change in Seccion Assignment: All proposals vs. Algorithmic proposal",
       caption = "(Changes grouped by year and proposal stage)", y="Proportion Changed", x="Edon", color="creator")
```
## Pareto Curve  
```{r pareto-analysis}
# valid major party proposals]
validPlans.tbl <- planFull.df %>% 
  rowwise() %>%
  filter(VALIDPLAN) %>% 
  filter(!is.null(plan))  %>%
  ungroup()

validPlans.tbl  %<>%
  rowwise() %>% 
  mutate(average_winning_margins =
          ifelse(
            year==2013, 
            mean(plan_2012_actors_winMargins$win_margin),
            mean(plan_2015_actors_winMargins$win_margin)
          )
         ) %>%
  ungroup()

# validScores.tbl <- validPlans.tbl %>%
#   select("planid","rscore","tla",
#          "mean_win_2015","plan_2015_muniSplits","plan_2015_actors_winMargins_compCount",
#          "plan_2015_districts_maxPopDev","plan_2015_actors_winMargins") %>% 
#   rename(official_score=rscore, municiple_splits = plan_2015_muniSplits,
#          competitive_districts = plan_2015_actors_winMargins_compCount,
#          worst_population_deviation = plan_2015_districts_maxPopDev,
#          average_winning_margins = mean_win_2015,
#          win_margins = plan_2015_actors_winMargins
#          )

validScores.tbl <- validPlans.tbl %>%
  rename(official_score=rscore) %>%
  rowwise() %>%
  mutate(
    municiple_splits = ifelse(year==2013, plan_2012_muniSplits, plan_2015_muniSplits ),
    competitive_districts = ifelse(year==2013, plan_2012_actors_winMargins_compCount,
                                   plan_2015_actors_winMargins_compCount ),
    worst_population_deviation = ifelse(year==2013, plan_2012_districts_maxPopDev, plan_2015_districts_maxPopDev ),
    win_margins = ifelse(year==2013, list(plan_2012_actors_winMargins), list(plan_2015_actors_winMargins) )
 
  ) %>% 
  select ("planid", "tla", "municiple_splits", "competitive_districts", 
          "worst_population_deviation", "average_winning_margins", "win_margins","official_score") 


validScores.tbl %>% 
  select(-win_margins) %>%
  GGally::ggpairs( columns=c("official_score","municiple_splits", "competitive_districts", "worst_population_deviation", "average_winning_margins"))


```


## revealed preference properties
```{r revealed-analysis}
# valid major party proposals
counterScore <- function(p1,p2,proposer) {
  if (is.null(proposer)) {proposer=""}
  rows.tib <- left_join(by="planid",tibble(planid=c(p1,p2)), validScores.tbl) %>%
    rowwise() %>%
    mutate(
      proposer_win_margin = ifelse( is.null(win_margins) , NA_real_ , 
                                    (win_margins %>% filter(win_actor==proposer) %>% pull(win_margin) %>% mean(na.rm=TRUE) )
      ),
      proposer_win_seat = ifelse( is.null(win_margins) , NA_real_ , 
                                  (win_margins %>% filter(win_actor==proposer) %>% 
                                     pull(win_margin) %>% na.omit() %>% length() )),
     comp_margin = ifelse( is.null(win_margins) , NA_real_ , 
            (win_margins %>% filter(win_margin<.02) %>% pull(win_margin) %>% mean(na.rm=TRUE) %>% 
               replace_na(0))
      )
    ) %>%
    mutate(proposer_win_margin=replace_na(proposer_win_margin,0)) %>%
    select(-tla,-planid,-win_margins)
  diff_cols<-rows.tib[1,]-rows.tib[2,]
  diff_cols %<>%   rename(score_difference=official_score, 
                          split_difference = municiple_splits, 
                          win_difference = average_winning_margins,
                          population_difference = worst_population_deviation,
                          competitive_difference = competitive_districts,
                          competitive_margin_difference= comp_margin,
                          proposer_win_difference=proposer_win_margin,
                          proposer_seat_difference = proposer_win_seat) %>%
    mutate(proposer_composite_difference = 1000 * proposer_seat_difference + 100 * competitive_difference -  10*competitive_difference + proposer_win_difference)
  res <- bind_cols(diff_cols, rows.tib[1,c("proposer_win_margin","proposer_win_seat","competitive_districts")])
  res
}

#debug(counterScore)

propmatchf.df <- proptrans.df %>% 
  rowwise() %>%
  mutate(hasplan = !is.null(plan)) %>%
  filter(PROPOSED==TRUE, stage %in% c(2,4), VALIDPLAN==TRUE) %>%
  select(planid,year,edon,stage,actor,actortype,tla,hasplan) %>%
  mutate(previous_stage = stage-1) %>% 
  ungroup() %>%
  left_join(by=c("year","edon","previous_stage"),
            proptrans.df %>% select(year,edon,stage,planid) %>% 
              rename(previous_id=planid, previous_stage=stage)) %>%
  select(-previous_stage)


propmatch.df <- propmatchf.df %>%
  rowwise() %>% 
  filter(hasplan) %>%
  ungroup()


propmatch.df%<>% left_join(by="planid", planFull.df %>% select(planid,win_section8,unanimous_creator,creators))


propmatch.df %<>% 
  rowwise() %>%
  mutate(counter=counterScore(planid,previous_id,actor)) %>%
  ungroup() %>% 
  unpack(counter)


library(gtsummary)

propmatch.df %>% 
  filter(actortype %in% c("major","minor")) %>%
  mutate(actortype = fct_drop(actortype)) %>%
  select("score_difference","split_difference", "competitive_difference", "population_difference", "win_difference","actortype", "proposer_win_difference", "proposer_seat_difference","competitive_margin_difference", "proposer_composite_difference") %>%
  tbl_summary(by=actortype,type = list(everything() ~ "continuous"),
          statistic = list(all_continuous() ~ "{mean} ({sd}) [{min}-{max}]") ) %>%
 as_gt() %>% 
  tab_header(title="Counterproposal Differences by Actor Type")
 
propmatch.df %>% 
  filter(actortype %in% c("major")) %>%
  mutate(actorf = fct_drop(actor)) %>%
  select("score_difference","split_difference", "competitive_difference", "population_difference", "win_difference","actorf", "proposer_win_difference",  "proposer_seat_difference","competitive_margin_difference", "proposer_composite_difference",) %>%
  tbl_summary(by=actorf,type = list(everything() ~ "continuous"),
          statistic = list(all_continuous() ~ "{mean} ({sd}) [{min}-{max}]") ) %>%
 as_gt() %>% 
  tab_header(title="Counterproposal Differences by Major Party ")
 
 
propmatch.df %>% 
  filter(actortype %in% c("major")) %>%
  mutate(actortype = fct_drop(actortype)) %>%
  select("score_difference","split_difference", "competitive_difference", "population_difference", "win_difference","year","proposer_win_difference",  "proposer_seat_difference", "proposer_composite_difference") %>%
  tbl_summary(by=year,type = list(everything() ~ "continuous"),
          statistic = list(all_continuous() ~ "{mean} ({sd}) [{min}-{max}]") )  %>% 
  as_gt() %>% 
  tab_header(title="Major Parties: Counterproposal Difference by Year")

propmatch.df %>% 
  filter(actortype %in% c("major"), win_section8 | unanimous_creator) %>%
  select("score_difference","split_difference", "competitive_difference", "population_difference", "win_difference","year","proposer_win_difference", "proposer_seat_difference", "competitive_margin_difference", "proposer_composite_difference",) %>%
  tbl_summary(by=year,type = list(everything() ~ "continuous"),
          statistic = list(all_continuous() ~ "{mean} ({sd}) [{min}-{max}]") )  %>% 
  as_gt() %>% 
  tab_header(title="Unanimous Proposals: Difference by Year (Major Parties) ")


propmatch.df  %>% 
  filter(actortype %in% c("major","minor")) %>%
  GGally::ggpairs(
    columns=c("score_difference","split_difference", "competitive_difference", "population_difference", "win_difference","proposer_win_difference", "proposer_seat_difference", "proposer_composite_difference"), 
                   aes(color=actortype))

counterprop.df <- propmatch.df %>% filter(actor=="PAN") %>% rowwise() %>% mutate(creators=paste(collapse=",",unlist(creators)))

write_excel_csv(counterprop.df,file="PAN_counterproposals.csv")


yuc.df <- propmatch.df %>% filter(tla=="yuc") %>% rowwise() %>% mutate(creators=paste(collapse=",",unlist(creators)))

write_excel_csv(yuc.df,file="yuc_counterproposals.csv")


```

```{r preference-reversals}


# create proposal table
planset <- function(previous_id,planid, edon, stage, year) {
   r <- propmatch.df %>% filter(edon==1, stage=="4",year=="2013")  %>% pull(planid)
   r <- setdiff(r,planid)
   r <- append(r,previous_id)
   expand.grid(x=planid,y=r)
}

propseq.tib <- propmatchf.df %>% select(planid,year,edon,stage,actor,actortype,tla,previous_id)
propseq.tib %<>% rowwise() %>%
  mutate( planset = list(planset(previous_id, planid,edon,stage,year)) ) %>%
  ungroup()
propseq.tib <- inner_join(propseq.tib %>% filter(stage==2),propseq.tib %>% filter(stage==4),
          by=c("year"="year","actor"="actor","edon"="edon","tla"="tla","actortype"="actortype"))
propseq.tib %<>% filter(planid.x != planid.y)
propseq.tib %<>% group_by(year,edon,actor) %>% slice_head(n=1) %>% ungroup()

# create alternative scores

reversalcheck <- function(ps1,ps2) {
  r <- inner_join(ps1,ps2, by = c("x"="y","y"="x"))
  nrow(r) > 0
}

#debug(reversalcheck)
propseq.tib %<>% rowwise() %>%
  mutate(reversal=reversalcheck(planset.x,planset.y))

proprev.tib <- propseq.tib %>% filter(reversal)

```



## Municipality Analysis
```{r municipality-demographic}

votes.2015.df <- read_csv("mxDistritos-data/raw-seccion-2015.csv", 
                          col_types=cols( .default = col_double()))
votes.2018.df <- read_csv("mxDistritos-data/raw-seccion-2018.csv",
                          col_types=cols( .default = col_double()))
votes.2018.df %<>%  clean_vraw()
votes.2015.df %<>%  clean_vraw()

# municipality grouped data
munis_actors_2015.tbl <- votes.2015.df %>% 
  mutate(edon=factor(edon,labels = statecodes.df %>% pull(tla))) %>%
  group_by(edon,inegi,actor) %>% 
  summarize(sumvotes=sum(votes,na.rm=TRUE)) %>%
  select(edon,inegi,actor,sumvotes) %>%
  group_by(edon,inegi) %>%
  mutate(propvotes=sumvotes/sum(sumvotes,na.rm=TRUE)) %>% 
  ungroup() 

munis_actors_2018.tbl <- votes.2018.df %>% 
  mutate(edon=factor(edon,labels = statecodes.df %>% pull(tla))) %>%
  group_by(edon,inegi,actor) %>% 
  summarize(sumvotes=sum(votes,na.rm=TRUE)) %>%
  select(edon,inegi,actor,sumvotes) %>%
  group_by(edon,inegi) %>%
  mutate(propvotes=sumvotes/sum(sumvotes,na.rm=TRUE)) %>% 
  ungroup() 

winvotes_2015.df <- votes.2015.df %>% 
  mutate(edon=factor(edon,labels = statecodes.df %>% pull(tla))) %>%
  group_by(edon,disn_adopt,actor) %>% 
  summarize(actor_vote=sum(votes,na.rm=TRUE)) %>%
  group_by(edon,disn_adopt) %>%
  summarize(distmaxvote=max(actor_vote),
            distwinvote=sort(actor_vote,decreasing=TRUE)[2],
            disttotal=sum(actor_vote,na.rm=TRUE),
            winthresh = distwinvote/disttotal)

winvotes_2018.df <- votes.2018.df %>% 
  mutate(edon=factor(edon,labels = statecodes.df %>% pull(tla))) %>%
  group_by(edon,disn_adopt,actor) %>% 
  summarize(actor_vote=sum(votes,na.rm=TRUE)) %>%
  group_by(edon,disn_adopt) %>%
  summarize(distmaxvote=max(actor_vote),
            distwinvote=sort(actor_vote,decreasing=TRUE)[2],
            disttotal=sum(actor_vote,na.rm=TRUE),
            winthresh = distwinvote/disttotal)

# compare municipality party votes to district winning vote thresholds

munis_actors_2015.tbl %>% 
  group_by(edon,inegi) %>%      
  summarize(maxvotes=max(sumvotes,na.rm=TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x=edon,y=maxvotes,color="Municipal Party Vote")) +
  geom_boxplot() +
  labs (subtitle="2015",x="votes",y="") -> p1


geom_boxplot(
  data = winvotes_2015.df, 
  aes(x=edon,y=distwinvote,color="Winning Vote Threshold") ) -> p1.1


munis_actors_2018.tbl %>% 
  group_by(edon,inegi) %>%      
  summarize(maxvotes=max(sumvotes,na.rm=TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x=edon,y=maxvotes,color="Municipal Party Vote")) +
  geom_boxplot() +
    labs (subtitle="2017",x="votes",y="") -> p2


geom_boxplot(
  data = winvotes_2018.df, 
  aes(x=edon,y=distwinvote,color="Winning Vote Threshold") ) -> p2.1

(p1 + p1.1 + coord_flip()) / (p2 + p2.1 + coord_flip())

### Distribution of concentration at different levels of aggregation
votes.2015.df %>% 
  group_by(edon,actor) %>% 
  summarize(sumvotes=sum(votes,na.rm=TRUE)) %>%
  mutate(propvotes=sumvotes/sum(sumvotes,na.rm=TRUE)) %>% 
  group_by(edon) %>%
  mutate(concentration=max(propvotes)) %>%
  ungroup() %>%
  ggplot(aes(x=concentration)) +
  geom_density(bw=.01,outline.type="both",aes(fill="edon"),alpha=.1) +
  geom_density(data=
    votes.2015.df %>%
    group_by(edon,seccion) %>%
    mutate(concentration=max(votes)/sum(votes,na.rm=TRUE)) %>%
    ungroup(),
    bw=.01,outline.type="both",mapping=aes(fill="seccion"),alpha=.1)  +
  geom_density(data=
    votes.2015.df %>% 
group_by(edon,actor,inegi) %>% 
  summarize(sumvotes=sum(votes,na.rm=TRUE)) %>%
  group_by(inegi) %>%
  mutate(concentration=max(sumvotes)/sum(sumvotes)),
    bw=.01,outline.type="both",mapping=aes(fill="municipality"),alpha=.1) + 
  theme(axis.text.y=element_blank())-> p2


plot (p2+p2+facet_wrap(vars(edon),4))

## Municipality influence in 2015 and 2017
  votes.2015.df %>% rename(district=disn_adopt) %>%
    scoreMuniDominate() %>% 
    ggplot(aes(x=prop_influence)) + 
    geom_histogram(bins=15) + 
        stat_bin(aes(y=..count.., label=..count..), geom="text", bins=15, vjust=-.5) +
         geom_vline(xintercept=.30 , colour="grey") +
        geom_text(aes(x=.32, label="Win threshold.", y=50), colour="red", angle=90, vjust = 0, text=element_text(size=11))+
        labs(y="", 
             x="Share of District Vote", 
             title="Influence of Municipalities", 
             subtitle="2015"
          )  -> inf2015.pl
  
  votes.2018.df %>% rename(district=disn_adopt) %>% scoreMuniDominate() %>%
  ggplot(aes(x=prop_influence)) + 
    geom_histogram(bins=15) + 
        stat_bin(aes(y=..count.., label=..count..), geom="text", bins=15, vjust=-.5) +
        geom_vline(xintercept=.30 , colour="grey") +
        geom_text(aes(x=.32, label="Win threshold.", y=50), colour="red", angle=90, vjust = 0, text=element_text(size=11))+
       labs(y="Number of districts", 
             x="Share of District Vote", 
             title="", 
             subtitle="2017",
             caption = str_wrap("Vote for a single party that comes from a single unsplit municipality.",40))-> inf2018.pl
  
  
inf2015.pl+inf2018.pl

# winning vote distribution

(winvotes_2015.df %>% 
  ggplot(aes(x=winthresh)) + 
  geom_histogram())/
(winvotes_2018.df %>% 
  ggplot(aes(x=winthresh)) + 
  geom_histogram())

# splits vs margins

planProcessing.df  %>% rowwise() %>% mutate(meanwin=mean(plan_2015_actors_winMargins$win_margin,na.rm=TRUE))%>% ggplot(aes(x=plan_2015_muniSplits,y=meanwin),alpha=.01) + geom_jitter() 


# How many districts in 2015 were won for PRI by a single municipality
# How many districts in 2018 were won for MORENA by a single municipality

votes.2015.df %>% rename(district=disn_adopt) %>%
    scoreMuniDominate()  %>%
    rename(disn_adopt=district) %>%
   mutate(edon=factor(edon,labels = statecodes.df %>% pull(tla))) -> smd.2015.tbl

smd.2015.tbl %<>% left_join(winvotes_2015.df)

votes.2018.df %>% rename(district=disn_adopt) %>%
    scoreMuniDominate()  %>%
      rename(disn_adopt=district) %>%
   mutate(edon=factor(edon,labels = statecodes.df %>% pull(tla))) -> smd.2018.tbl
smd.2018.tbl %<>% left_join(winvotes_2018.df)

winvotes_2015.df %>% ungroup()  %>% select(winthresh) %>% pull() %>% quantile(probs = c(.5,.8,.9,.95,.99))
winvotes_2018.df %>% ungroup()  %>% select(winthresh) %>% pull() %>% quantile(probs = c(.5,.8,.9,.95,.99))



smd.2015.tbl %>% filter(winthresh <= prop_influence)  %>% nrow()
smd.2018.tbl %>% filter(winthresh <= prop_influence) %>% nrow()
```


```{r ideal-gerry}

votes.2015.df <- read_csv("mxDistritos-data/raw-seccion-2015.csv", 
                          col_types=cols( .default = col_double()))
votes.2018.df <- read_csv("mxDistritos-data/raw-seccion-2018.csv",
                          col_types=cols( .default = col_double()))
votes.2018.df %<>%  clean_vraw()
votes.2015.df %<>%  clean_vraw()


optGerry <- function(year, target_actor,mg=0,th=.5) {
  v.df <-eval(as.symbol( paste("votes",year,"df",sep=".") ))
  
  upperEst <- function(nd,ts,as,mgo=mg, tho=th) {
        tt.l <- (ts/(nd))*(1-mgo) * tho +1
        tt.u <- (ts/(nd))*(1+mgo) * tho +1
        res.lower  <-  min(floor(as/tt.u),floor(nd/2))
        res.upper <- floor((as - res.lower * tt.l) / tt.u)
        res <- res.lower + res.upper
        res <-  max(0,min(nd,res))
        res
  }
  
  
  # 1000 pop
  # 5 districts
  # absorption = 1000/5 * .5 
  
  lowerEst <- function(nd,ts,as,tp, mgo=mg, tho=th) {
      res <- 0
      as.remaining <- as
      nd.remaining <- nd
      
      
      while ((as.remaining/nd.remaining) > (ts/nd.remaining * tho)) { #check to see if cracking works on remainder
        # pack a district with supporters
        res %<>% +1
        as.remaining %<>% - (tp/nd*(1+mgo))
      }
      res
  }
  
  state_summary.df <- v.df %>% 
    filter(actor==target_actor) %>% 
    group_by(edon) %>%
    summarize(total_pop = sum(na.rm=TRUE, lisnom),
              actor_sum = sum(na.rm=TRUE, votes),
              turnout_sum = sum(na.rm=TRUE, efec),
              ndists = length(unique(na.omit(disn_adopt)))) %>%
    ungroup() %>%
    rowwise() %>%
    mutate(
      ideal_pop = total_pop/ndists,
      turnout_target = turnout_sum / ndists * .5,
      actor_upper=upperEst(ndists,turnout_sum,actor_sum),
      actor_lower=lowerEst(ndists,turnout_sum,actor_sum,total_pop),
    ) %>% ungroup()
#  print(state_summary.df)
  state_summary.df %>% summarize(max=sum(actor_upper),min=sum(actor_lower))
}

ay.tbl <- expand_grid(actor=c("MORENA","MC","PAN","PRI","PRD"), year=c(2015,2018))

optTable.tbl <- actor_best.tbl

optTable.tbl  %<>% bind_rows( ay.tbl %>% 
  rowwise() %>%
  mutate( opt = optGerry( year , actor,th=.42,mg=.15)) %>%
  unpack(opt) %>%
  pivot_longer(cols=c(min,max), values_to="seats", names_to="type") %>% 
  rowwise() %>%
  mutate(type=paste(sep="",type,"_theory")) %>%
  ungroup()
)




optTable.tbl %>%
  pivot_wider(names_from=type,values_from=seats,values_fill=0) %>%
  rename(max_submitted=max,min_submitted=min) %>%
  relocate(actor,min_submitted,max_submitted) %>%
  rowwise() %>%
  mutate(year=as.character(year),
         mapping_freedom = max_submitted-min_submitted, 
         distribution_freedom = max_theory-min_theory
         ) %>%
  arrange(year,actor) -> optTable_l.tbl

optTable_l_delta.tbl <-
  optTable_l.tbl %>% 
  group_by(actor) %>%
  summarize(across(-year,function(x)x[2]-x[1]), year="Change: 2018-2015")

bind_rows(optTable_l.tbl,optTable_l_delta.tbl) %>%
  arrange(year,actor) %>%
  group_by(year) %>%
  gt() %>%
  gt_theme_538()






```


#Diagnostics
```{r}
seats.tbl %>% group_by(year,year_elec,scenario) %>% summarize(total=sum(seats))
nullids <- planFull.df %>% filter((win_final | best_nonmissing | first_appeared==1) & is.null(plan)) %>% select(planid)
nullplans<- left_join(nullids,propfull.df)
nullplans %>% gt()

```
# Yucatan local election prediction analysis

```{r}
yuc_returns.tbl <- votes.2015.df %>% filter(edon==31) %>% select("seccion","actor","votes") %>% rename(votes_2015=votes)

yuc_returns.tbl %<>% left_join(
  votes.2018.df %>% filter(edon==31) %>% select("seccion","actor","votes") %>% rename(votes_2018=votes),
  by=c("seccion"="seccion","actor"="actor"))

yuc_local.tbl <- read_csv("mxDistritos-data/DiputadosLocalMR2015YucatanSeccion.csv") %>% 
  select("SECCION", starts_with("PAN"), starts_with("PRI"), starts_with("PRD"), starts_with("PVEM"),
         starts_with("PT"), starts_with("PH"), starts_with("ES"), starts_with("MORENA"))  %>%
         mutate(across(everything(), ~replace_na(.x,0))) %>%
        rowwise() %>% 
        mutate( PAN=sum(c_across(starts_with("PAN"))), 
                PRI=sum(c_across(starts_with("PRI"))), 
                PRD=sum(c_across(starts_with("PRD")))) %>%
        select("SECCION","PAN","PRI","PRD","PVEM","PT","PH","ES","MORENA") %>%
        rename("seccion"="SECCION") %>% 
        pivot_longer(c("PAN","PRI","PRD","PVEM","PT","PH","ES","MORENA"),names_to="actor", values_to="votes_local_2015")

yuc_returns.tbl %<>% 
  left_join(yuc_local.tbl, by=c("seccion","actor")) %>%
  mutate(votes_local_2015=replace_na(votes_local_2015, 0)) %>%
   group_by(seccion) %>%
  mutate(across(starts_with("vote"), .names="{.col}_p",  ~ (.x/sum(.x))) ) %>%
  ungroup()

library("corrr")

yuc_returns.tbl %>% 
  filter(actor %in% c("PAN")) %>%
  select(-seccion,-actor) %>%
  correlate()

yuc_returns.tbl %>% 
  filter(actor %in% c("PRI")) %>%
  select(-seccion,-actor) %>%
  correlate()

yuc_returns.tbl %>% 
  filter(actor %in% c("MORENA")) %>%
  select(-seccion,-actor) %>%
  correlate()


```

# Debug

```{r}
ghost.tbl  <- proptrans.df %>% filter(!is.na(PROPOSED) & !PROPOSED & hasplan )

# check seccion count
```

