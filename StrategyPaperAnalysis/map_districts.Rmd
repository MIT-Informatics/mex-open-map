---
title: "R Notebook"
output: html_notebook
---


```{r}
library(utils)
setwd("C:/Users/Brandon/Documents/Strategy_Paper_SHP")
otimeout <- getOption("timeout")
options(timeout=1200)
# TODO: There is probably a better source. Extract from 3GB Inegi census?
#download.file("https://pautas.ine.mx/transparencia/mapas/cob_2020/SECCION.zip","SECCION2.zip")
#options(timeout=otimeout)
#unzip("SECCION2.zip")

```



```{r}
library("sf")
seccion_base.sf <- read_sf("C:/Users/Brandon/Documents/Strategy_Paper_SHP/2017_07_test/07/SECCION.shp", check_ring_dir=TRUE)
seccion_base.sf2 <- read_sf("C:/Users/Brandon/Documents/Strategy_Paper_SHP/2017_11_test/11/SECCION.shp", check_ring_dir=TRUE)
district <- read_sf("C:/Users/Brandon/Documents/Strategy_Paper_SHP/2017_11_test/11/DISTRITO.shp", check_ring_dir=TRUE)
```

```{r}
library(tidyverse)
library(magrittr)
library(ggplot2)

i<-2
 

seccion_base.sf %>% filter(entidad==planFull.df[[i,"edon"]]) %>% 
  left_join(planFull.df[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf()


```

```{r}
j<-3  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(planFull.df[[i,"plan"]][[1]],planFull.df[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf %>% filter(entidad==planFull.df[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
```
```{r}
i<-2 ; j <- 3
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```


###STATE BY STATE ANALYSIS
###Comparing Algorithm Plans + Winning Plans 2013 vs. 2017

#7
#winning different from Algorithm
```{r}
i<-118
 

seccion_base.sf %>% filter(entidad==planProcessing.df[[i,"edon"]]) %>% 
  left_join(planProcessing.df[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf()

```
```{r}
j<-113  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(planProcessing.df[[i,"plan"]][[1]],planProcessing.df[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf %>% filter(entidad==planProcessing.df[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
i<-118 ; j <- 113
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```


```{r}
tempPlan <- planProcessing.df %>% filter(edon == 11)
```

#11
Algorithm v Winning Plan (2013)
```{r}
i<-4
 

seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(tempPlan[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf(color=NA)

j<-1
 
seccion_base.sf2 %>% filter(entidad==tempPlan[[j,"edon"]]) %>%
  left_join(tempPlan[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf(color=NA)

```
```{r}
j<-1  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(tempPlan[[i,"plan"]][[1]],tempPlan[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
i<-4 ; j <- 1
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```
Algorithm v Winning Plan (2017)
```{r}
i<-10
 
seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(tempPlan[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf(color=NA)
j<-12
 
seccion_base.sf2 %>% filter(entidad==tempPlan[[j,"edon"]]) %>%
  left_join(tempPlan[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf(color=NA)

```
```{r}
j<-12  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(tempPlan[[i,"plan"]][[1]],tempPlan[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
i<-10 ; j <- 12
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```
Base (2004) v Alg (2017)
```{r}
i<-28
 

seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(tempPlan[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf()

```
```{r}
j<-24  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(tempPlan[[i,"plan"]][[1]],tempPlan[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
i<-28 ; j <- 24
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```

Base (2004) v Winning (2017)
```{r}
i<-28
 

seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(tempPlan[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf()

```
```{r}
j<-26  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(tempPlan[[i,"plan"]][[1]],tempPlan[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf2 %>% filter(entidad==tempPlan[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
i<-28 ; j <- 24
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```
#### Academic Maps

```{r}
Academic_maps <- planProcessing.df %>%
  filter(planid == "42.41505-15-2013" | planid =="academic-pri-A" | planid == "academic-pri-emmPobOk" | planid == "academic-pri-ericMagarPobOk" | planid == "academic-pri-pedro.esquivel.v1")
```

```{r}
i<-305
 

seccion_base.sf %>% filter(entidad==planProcessing.df[[i,"edon"]]) %>% 
  left_join(planProcessing.df[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf()


```
#Academic-Pri-A
```{r}
j<-1  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(planProcessing.df[[i,"plan"]][[1]],planProcessing.df[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf %>% filter(entidad==planProcessing.df[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
i<-305 ; j <- 3
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```
Academic-Pri-emmpobok
```{r}
j<-2  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(planProcessing.df[[i,"plan"]][[1]],planProcessing.df[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf %>% filter(entidad==planProcessing.df[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
```
Academic-pri-ericmagarpobok
```{r}
j<-3  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(planProcessing.df[[i,"plan"]][[1]],planProcessing.df[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf %>% filter(entidad==planProcessing.df[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
```

Academic-pri-pedro.esquivel.v1
```{r}
j<-4  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(planProcessing.df[[i,"plan"]][[1]],planProcessing.df[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf %>% filter(entidad==planProcessing.df[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
```


```{r}
plan1 <- planProcessing.df[[119,"plan"]][[1]] 
plan2 <- planProcessing.df[[1,"plan"]][[1]] 



tmp %>% filter(!str_detect(planid,"base")) %>% 
  group_by(edon) %>% 
  summarise(mean(base_diff_percent),base_diff_delta=mean(base_diff_delta))

tmp %>% 
  filter(edon %in% c(2,15)) %>% 
  rowwise() %>% 
  mutate(ndists = length(na.omit(unique(plan$district)))) %>% 
  select(planid,edon,ndists)

# compare each plan to baseline
# compare to algorithm plan
# compare to prior proposal
#TODO: academic- districts and 13.74065-2-2013	have wrong number of dists

```

