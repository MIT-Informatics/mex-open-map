---
title: "Proposal Analysis"
output: html_notebook
---

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Description: This notebook file was created by A. Trelles on 12/28/19 as part of the Strategy Paper. 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

General Description: This analyisis is used as a reference to write the code for the analysis of partisan counterporposals for the 2013 and 2017 redistricting process in relation with partisan ruling status, its strenght (vote returns), and state level coalition dynamics.  

The first part of the ProposalAnalysis.Rmd IS NOT CODE. It describes the general objectives of the analysis based on the hypotheses derived from the paper and the available data we have to test them. In all cases, the DV is related to a partyÂ´s decision to formulate a counterporposal. 

General Hypotheses H1, H2, and H3 assume the DV is if a party formulated a counterporposal,
and vary according the ruling party (H1), party strenght/vote returns (H2), and coalitions (H3). 


// Setup //

Libraries
```{r}
require(magrittr)
require(ggplot2)
require(dplyr)
require(tidyr)
require(readr)
require(haven)
```
Bring in proposal event database: propfull.df
```{r}
# reads in Pre-Normalized IFE tables and produces proposals.df data
source("Normalize.R")
# integrates in plans from MxDistritos
source("integrateMxdistritos.R")
```
Bring in ruling party db, 
```{r}
source("RulingParty_micah.R")
grule.df %<>% left_join(statecodes.df)

```

//////////////////////////////////////////////////////////////////////////////////////////
H1: Ruling Party (Single Party Dominance/Alternation)
//////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////
H1.1: Decision of Entry (Party deciides if it plays the game based on Ruling Party at the state level) --> Decision of political parties to participate in redistricting based on degree of alternatioin at the state level.  
//////////////////////////////////////////////////////////////////////////////////////////
Hypotheses (Entry --> Based on Ruling Party in Single Party Rule States):

#H.1.1 The ruling party is more likely to participate in redistricting (formulate a counterproposal) than all other opposition parties. 

#H.1.2 Parties competing for power in that state (secondary or terciary forces) will be more likely to engage than smaller parties. 

#H.1.3 Parties ruling a state under single party dominance are more likely to participate in redistricting (formulate a counterproposal) than all other opposition parties. 

  Variables: 
#DV: Dummy variable capturing if party formulated a proposal (proposals.df: PROPOSED: True or False, by sate, stage, level, and year) Alternative (ys.proposed: proposed:0-4, by state and year).

#IV(1): Variable captruing if a single party ruled that state before redisrticting took place. We use two different time periods (2000-2013 and 2000-2017) based on the data grule.df (ys.proposed: CONTROL:singlecontrol,primary,"NONE"). 

#IV(2) Variable capturing which party was ruling the state the year redistricting took place (grule.df: party ruling by state in 2013 and 2017)

#IV(3) Variable capturing the relative presence/dominance of parties at the state level, based on the number of times they have ruled in the 2000-2013 and the 2000-2017 period (Priamry, Secondary, or Terciary Force). In case of tie, rank first the latest party to rule that state. 

#IV(4): Variable captruing the degree of alternation in power (six categories from a non-competitive  to multiparty comptetion and alternation has taken place 3+ times, for the 00-13 and 00-17 periods): 1) states dominated by a single party; 2) Alternation took place once (only two parties); 3) Alternation has taken place twice (with only two parties); 4) Alternation has taken place twice (with more than 3 parties); 5) Altrernation has taken place three times (involving 2 parties) 6) Altrernation has taken place three times (involving 3+ parties).--> **Need to create this variable --> Proposed Name: ALTERNATION**

  Objective:
# Evaluate the incentives parties to formulate counterproposals (decision to enter the process/to play the game) based on the Ruling Party hypotheis. --> We suspect that 1) parties ruling a state are more likely to engage in the process, 2) that parties competing for power in that state (secondary or terciary forces) will be more likely to engage than smaller parties, 3) that parties ruling a state under single party dominannce are more likely to formulate a counterproposal than those that are experience a higher degree of ALTERNATION/MULTIPARTY COMPETITION.  

  Descriptive Anslysis
  
#Visualization-->  1) Tables/graphs summarizing the total number of proposals made by each party during the 2013 and 2017 processes, by stage (firs vs second round), and at the local and national level. 2) Tables/graphs summarizing the total number of proposals made by each party at the state level; at the stage and year level--> Parties(actor) for 2013: "PAN PRI PRD PT PVEM MC PNA" Parties for 2017: "PAN PRI PRD PT PVEM MC PNA MORENA ES"

  
  Propositions/Questions realted to H1 to be Evaluated (Code developed by RA)

#H.1.1 The ruling party is more likely to participate in redistricting (formulate a counterproposal) than all other opposition parties. 

#H.1.2  Parties competing for power in that state (secondary or terciary forces) will be more likely to engage than smaller parties. 

#H.1.3 Parties ruling a state under single party dominance are more likely to participate in redistricting (formulate a counterproposal) than all other opposition parties.



```{r}
#Code to create variables needed
ys.proposed <- propfull.df %>% group_by(actor,Entidad,year) %>% summarise(proposed=sum(PROPOSED,na.rm=TRUE))
#output <- propstrue(proposals.df)
ys.control<- grule.df %>%  controlByWindow(2000,2013) %>% transmute(edon=edon, year=2013,                                 control=if_else(singlecontrol,primary,"NONE"))

ys.control %<>% bind_rows (grule.df %>%  controlByWindow(2000,2017) %>% transmute(edon=edon, year=2017,                              control=if_else(singlecontrol,primary,"NONE")))

ys.proposed %<>% left_join(ys.control)
rm(ys.control)
ys.proposed %>% ggplot(aes(control,proposed))+geom_boxplot()+facet_grid(rows=vars(year))


```

  #H.1.1.1.a 
#Comparing the decision of the ruling party to formulate a counterproposal to other parties in that same state --> Requires  a dummy capturing if the state had single party dominance (single_pty_dom_00_17:True) --> In those states where the condition is met --> the ruling party is more likely to formulate a counterporposal than each opposition party in that same state. 

#Method: Difference of means test: H1: mean of ENTRY for the Ruling Party in a state with single party dominance > mean of ENTRY for each opposition party in that same state; H0: mean of ENTRY for the Ruling Party in a state with single party dominance <= mean of ENTRY for (each) opposition parties in that same state. 
```{r}
ys.proposed <- propfull.df %>% group_by(actor,edon,year) %>% summarise(numproposals=sum(PROPOSED,na.rm=TRUE))
ys.control<- grule.df %>%  controlByWindow(2000,2013) %>% transmute( edon=edon, year=2013,                                 singlecontrolparty=if_else(singlecontrol,primary,"NONE"))

ys.control %<>% bind_rows (grule.df %>%  controlByWindow(2000,2017) %>% transmute(edon=edon, year=2017,                              singlecontrolparty=if_else(singlecontrol,primary,"NONE")))

ys.proposed %<>% left_join(ys.control)
#rm(ys.control)

ys.proposed %<>% rowwise() %>% mutate(didPropose=(numproposals>0),didControl=(actor==singlecontrolparty))

require(broom)
require(GGally)
tabfit <- ys.proposed %>% xtabs(~didPropose+didControl+year,data=.)
print(tabfit)
ftable(tabfit)
ys.proposed %>% ggplot(aes(didControl,didPropose))+geom_col()+facet_grid(rows=vars(year))
glmfit <- ys.proposed %>% glm(didPropose~didControl+year,data=.,family=binomial())
summary(glmfit)
augment(glmfit) %>% ggplot(aes(didPropose,.fitted))+geom_jitter()+facet_grid(rows=vars(didControl))
ggcoef(glmfit)

```
#Years and number of proposals into factors
ys.proposed <- fastDummies::dummy_cols(ys.proposed, select_columns = "year")
ys.proposed <- fastDummies::dummy_cols(ys.proposed, select_columns = "numproposals")

#Data exploration
tabfit <- ys.proposed %>% xtabs(~didPropose+didControl,data=.)
print(tabfit)
ftable(tabfit)

#Logistic Model: Controlling for year

glm.mod <- glm(didPropose~didControl+year_2017, data=ys.proposed, family = binomial())
summary(glm.mod)

#Test the difference between coefficients.
library(car)
exp(coef(glm.mod))

#Explaination

#Logistic Model: Interaction, year and didControl

glm.mod.inter <- ys.proposed %>% glm(didPropose~didControl+year_2017+didControl*year_2017, data = ., family = binomial())
summary(glm.mod.inter)

#The interaction term is not significant by any means. A logistic model may not be the best regression model to descibe the data. This can also be seen by looking at the cross-tabs -- the data is unbalanced. 

summary(ys.proposed)

library(Zelig)
re.mod.1 <- ys.proposed %>% zelig(didPropose~didControl+year_2017, data = .,model = "relogit", tau = 29/649, case.control = "prior", bias.correct = FALSE)
summary(re.mod.1)

#The RE model does not provide any further insight into the causal effects of being the party in control on proposing redistricting plans. The data is unbalanced -- this should have taken care of that issue. The data is also "small" which compounds that issue, but makes it harder to solve (tau, in the model, is still large for a RE model).

#################################################################

#Exploring the data
tabfit.1 <- ys.proposed %>% xtabs(~numproposals+year,data=.)
print(tabfit.1)
ftable(tabfit.1)

#Logistic Model : Proposal in first round (2013)
glm.mod.b.1 <- glm(numproposals_1~didControl+year_2013, data=ys.proposed, family = binomial())
summary(glm.mod.b.1)

#Logistic Model:Proposal in second round (2013)
glm.mod.b.2.a <- glm(numproposals_2~didControl+year_2013, data = ys.proposed, family = binomial())
summary(glm.mod.b.2.a)

glm.mod.b.2.b <- glm(numproposals_2~didControl+numproposals_1+year_2013, data = ys.proposed, family = binomial())
summary(glm.mod.b.2.b)

#

#Logistic Model: Proposal in first round (2017)

#Logistic Model: Proposal in second round (2017)

######################################################################

```

  #H.1.1.1.b 
#Comparing the decision of the ruling party to formulate a counterproposal to other parties in states that have expereinced alternation in power. --> Requires a categorical variable capturing if degree of ALTERNATION or simply if single_pty_dom_00_17:False. This hypothesis is evaluating if the ruling party is more likely to formulate a counterporposal in states where there is single party rule, than in states where alternation takes place. 

#Method: Difference of means test: H1: mean of ENTRY for the Ruling Party in states with single party dominance > mean of ENTRY for the Ruling Party in states that have experienced alternation; H0: mean of ENTRY for the Ruling Party in states with single party dominance <= mean of ENTRY for the Ruling Party in states that have experienced alternation. 

```{r}
#Without year splits - why is year significant? Does it represent something that has to deal with the system?
str(ys.proposed)
glm.mod.h.1.1.b <- ys.proposed %>% glm(didPropose~singlecontrolparty+year, data=., family=binomial())
summary(glm.mod.h.1.1.b)

#With year splits
glm.mod.h.1.1.b.13 <- ys.proposed.13 %>% glm(didPropose~singlecontrolparty, data=., family=binomial())
summary(glm.mod.h.1.1.b.13)

glm.mod.h.1.1.b.17 <- ys.proposed.13 %>% glm(didPropose~singlecontrolparty, data=., family=binomial())
summary(glm.mod.h.1.1.b.17)

#The intercept in there models captures the effect of "NONE" or, the effect of having no single party control in that year based on at least a single alternation from the record of prior years.

#Build models with degree of alternation. 

```
//////////////////////////////////////////////////////////////////////////////////////////
WORK IN PROGRESS...
//////////////////////////////////////////////////////////////////////////////////////////

#H.1.1.2 Parties that are secondary or terciary forces at the state level, are more likely to participte in redistricting (formulate a counterproposal), than all other opposition parties. 

```{r}
#Build models with degree of alternation. 

#Variable that captures the degree of alternation

grule.df %<>% bind_rows(grule.df %>% mutate(alternation = grep("PAN", grule.df$party, value = FALSE, ignore.case = FALSE)), na.rm = TRUE)

alternation

for (i in 1:32){
  grule.df %<>% bind_rows(grule.df %>% controlByWindow(2000,2013) %>%
                            transmute(edon=i, alternation = grep("PAN",
                            grule.df$party, value = FALSE, ignore.case = FALSE),
                            na.rm=FALSE))
}
#Having issues making this work -- ask micah to help understand which functions to use.
```

#H.1.1.3 As alternation in power/ competition increases at the state level, we expect to observe a higher number of counterporposals.
  #H.1.1.3.a number of proposals by single party control.
  
```{r}
lm.mod.h.1.1.3.a <- ys.proposed %>% lm(numproposals~singlecontrolparty+year, data=.)
summary(lm.mod.h.1.1.3.a)

lm.mod.h.1.1.3.a.13 <- ys.proposed.13 %>% lm(numproposals~singlecontrolparty, data=.)
summary(lm.mod.h.1.1.3.a.13)

lm.mod.h.1.1.3.a.17 <- ys.proposed.17 %>% lm(numproposals~singlecontrolparty, data=.)
summary(lm.mod.h.1.1.3.a.17)

#Single party control is not significant in any of the meansures for parties that maintain a level of consistent control. Need to build out a variable that explains the degree to alternation in a state.
```
  #H.1.1.3.b number of proposals by degree of alternation

#1.1.1.4 Ruling parties in states with the highest level of alternation in power, are more likely to participte in redistricting (formulate a counterproposal), than all other opposition parties.


//////////////////////////////////////////////////////////////////////////////////////////
H1.2: Strategic Decision (Party deciides how to play the game based on the Ruling Party at the state level) --> Decision of a political party to participate in redistricting based on degree of alternatioin at the state level.  
//////////////////////////////////////////////////////////////////////////////////////////

Hypotheses (stage --> First vs Second Round):
 
#H.1.2.1.1 Parties are more likely to participate in redistricting (formulate a counterproposal) during the first round. 

#H.1.2.1.2 Parties ruling a state under single party dominance, are more likely to participate in redistricting (formulate a counterproposal) during the first round, than all other opposition parties. 


#H.1.2.1.3 Parties that are secondary or terciary forces at the state level, are more likely to participate in redistricting (formulate a counterproposal) during the first round, than all other opposition parties.

#1.2.1.4 As alternation in power/competition increases at the state level, the number of counterporposals in the second stage will be higher compared to states dominated by a single party.

Hypotheses (level --> CLV vs Federal):

#H.1.2.2.1 As alternation in power/competition increases at the state level, parties are more likely to formulate a counterproposal at the local level (CLV)

Hypotheses (Porcess --> 2013 vs 2017):

#H.1.2.3.1 Parties are more likely to formulate a counterproposal at the local level (CLV) in 2017 than in 2013. 




//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
STOP READING HERE (Below: Departing ideas for conversation 01/14/20)
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////
H1: Ruling Party (Single Party Dominance/Alternation)
//////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////
H1.1: Single Party Dominance (dominant party) --> Comparing dominant parties vs opposition parties in states ruled by a single party
//////////////////////////////////////////////////////////////////////////////////////////
Hypothesis:
# If a state is dominated by a single party prior the redistricting process, the ruling party in that state is more likely to formulate a counterproposal than any other party. 

Variables: 
#DV: Dummy variable capturing if party formulated a proposal (PROPOSED: True or False, by Sate, by round, by year).

#IV(1): Dummy variable captruing if a single party ruled that state before redisrticting took place (single_pty_dom_00_17:True or False, by State). 

#IV(2): Categorical variable captruing the degree of alternation in power (six categories from a non-competitive state to a party that has multiparty comptetion and alternation has taken place >3+ times in the 00-17 period): 1) single_pty_dom_00_17:True or False, by State; 2) alt_power1_00_17; 3) alt_power2_00_17; 4) alt_power2_00_17 x multi_comp_00_17; 5) alt_power3_00_17; 6) alt_power3_00_17 x multi_comp_00_17. 

Method:
#To test H1.1: chi.sq test.

#Comparing parties:If the hypothesis is true, we would expect that the dominating party in states ruled by a single party, is more likely to formulate a counterporposal than opposition parties (this hypothesis can be tested by stage and/or combining both stages 1 and 2).

//////////////////////////////////////////////////////////////////////////////////////////
H1.2: Alternation in Power (opposition party(ies)) --> Comparing opposition parties in states with alternation vs opposition parties in states ruled by a single party
//////////////////////////////////////////////////////////////////////////////////////////
Hypotheses:
# If a state has gone through alternation in power, the main oppoition party (secondary force) is as likely to formulate a counterporposal as the ruling party.

# If a state has gone through alternation in power, oppoition parties are as likely to formulate a counterporposal as the ruling party.

Variables: 
#DV: Dummy variable capturing if party formulated a proposal (PROPOSED: True or False, by Sate, by round, by year).

#IV(1): Dummy variable captruing if a single party ruled that state before redisrticting took place (single_pty_dom_00_17:True or False, by State). 

#IV(2): Categorical variable captruing the degree of alternation in power (six categories from a non-competitive state to a party that has multiparty comptetion and alternation has taken place >3+ times in the 00-17 period): 1) single_pty_dom_00_17:True or False, by State; 2) alt_power1_00_17; 3) alt_power2_00_17; 4) alt_power2_00_17 x multi_comp_00_17; 5) alt_power3_00_17; 6) alt_power3_00_17 x multi_comp_00_17. 

Method: 
#To test H1.1: chi.sq test.

#Comparing parties: In states that have experienced alternation in power, we expect the main opposition parties to be as likely as the dominating party to formulate a counterproposal. We expect a stronger effect as multiparty competition and alternation in power increase (this hypothesis can be tested by stage and/or combining both stages 1 and 2).

//////////////////////////////////////////////////////////////////////////////////////////
H1.3: Alternation in Power (alternation and multiparty competition) --> Comparing the total number of counterporposals at the state level as alternation and multiparty competition increase. 
//////////////////////////////////////////////////////////////////////////////////////////
Hypothesis:
# Paries in states with alternetion and multipary competition are more likely to formulate a higher number of counterproposals being formulated than prties in states that are dominated by a single party. 

or 

#As alternation and multipartycompetition incease, more proposals will be formulated.

Variables: 
#DV: Total number of counterproposals formulated. Based on the dummy variable capturing if party formulated a proposal (PROPOSED: True or False, by Sate, by round, by year).

#IV(1): Dummy variable captruing if a single party ruled that state before redisrticting took place (single_pty_dom_00_17:True or False, by State). 

#IV(2): Categorical variable captruing the degree of alternation in power (six categories from a non-competitive state to a party that has multiparty comptetion and alternation has taken place >3+ times in the 00-17 period): 1) single_pty_dom_00_17:True or False, by State; 2) alt_power1_00_17; 3) alt_power2_00_17; 4) alt_power2_00_17 x multi_comp_00_17; 5) alt_power3_00_17; 6) alt_power3_00_17 x multi_comp_00_17. 

Method: 
#To test H1.1: chi.sq test.

# If the hpothesis is true, we would expect to observe more counterporposals in states with more alternation and multiparty competition.


//////////////////////////////////////////////////////////////////////////////////////////
H2:Party Strenght (Vote Returns) 
//////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////
H2.1: Party Strenght (High vs Low vote returns at the seccion level)--> Comparing interaction under different levels of electoral returns 
//////////////////////////////////////////////////////////////////////////////////////////
Hypothesis
# If a party receives a high vote share in a state, it is more likely to formulate a counterproposal than those parties that receive a lower vote share.

Variables: 
#DV: Dummy variable capturing if party formulated a proposal (PROPOSED: True or False, by Sate, by round, by year).

#IV(1): Dummy variable captruing if a party has high or low levels of vote returns in a particular state before redisrticting took place (High > 50%, Low <24%). 

#IV(2): Categorical variable capturing the level of vote returns (Five categories: Very High(>75%), High(74%-50%), Medium (49%-25%), Low (24%-15%), Very Low (<14%). 

#IV(3): Continous variable capturing the vote share received by each party at the state level (0-100).

Method:
#To test H2.1: Chisq and Difference of means.

//////////////////////////////////////////////////////////////////////////////////////////
H2.2: Party Competion (High vs Low levels of electoral competition)--> Comparing Interaction under different levels of competition 
//////////////////////////////////////////////////////////////////////////////////////////
Hypotheses
# As competitiveness increases at the state level (e.g., ratio of safe vs competitive districts), we can expect to observe a higher number of counterproposals.

and/or 

# As competitiveness increases (e.g., ratio of safe vs competitive districts), opposition parties are as likely to formulate a conterproposal as the ruling party. 

and/or 

# In a safe state, the ruling party is more likely to formulate a counterproposal than any other party.

and/or

# In a safe state, the main opposition party (secondary force) is as likely a formulate a counterproposal than the ruling party.

Variables: 
#DV: Dummy variable capturing if party formulated a proposal (PROPOSED: True or False, by Sate, by round, by year).

#IV(1): Dummy variable captruing if a state con be considered competitive or safe (High > 50%, Low <24%). 

#IV(2): Categorical variable capturing the level of district competitiveness at the state level (Five categories: Very High(>75%), High(74%-50%), Medium (49%-25%), Low (24%-15%), Very Low (<14%). 

#IV(3): Continous variable capturing the level of competitiveness in each district at the state level (0-100).

Method:
#To test H2.2: Chisq and Difference of means.


//////////////////////////////////////////////////////////////////////////////////////////
H2.3: Party Strongholds --> Comparing Interaction assuming parties want to protect strongholds 
//////////////////////////////////////////////////////////////////////////////////////////
Hypothesis
# ???? (Still working on this one). It seems this would be district or municipal level analysis to see if parties are protecting strongholds, but not at the entry/state level. 

Variables: 
#DV: Dummy variable capturing if party formulated a proposal (PROPOSED: True or False, by Sate, by round, by year).

#IV(1): Dummy variable captruing if a party has high or low levels in a particular state before redisrticting took place (single_pty_dom_00_17:True or False, by State). 

#IV(2): Categorical variable capturing the level of vote returns (Five categories: Very High(>75%), High(74%-50%), Medium (49%-25%), Low (24%-15%), Very Low (<14%). 

Method:
#To test H2.3: Difference of means.

#Comparing parties:.



//////////////////////////////////////////////////////////////////////////////////////////
H3: Coalitions
//////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////
H3.1: Coaltions (Stong and Succesful Coaltion)--> Comparing interaction based on the desission to build state level coalitions.  
//////////////////////////////////////////////////////////////////////////////////////////
Hypothesis
#Smaller parties (not PRI, PAN or PRD) that have a strong and successful coalition with a larger party, are more likely  to formulate a similar counterproposal to its larger coalition mate than smaller parties that competed separately. 

Variables: 
#DV: Dummy variable capturing if party formulated a proposal (PROPOSED: True or False, by Sate, by round, by year).

#IV(1): Dummy variable captruing if a party competed under a coalition before redisrticting took place. 

#IV(2): Dummy variable captruing if a coalition was strong and successful before redisrticting took place. 

Method:
#To test H3.1: Chisq test.

#Comparing parties:.


//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
STOP READING HERE
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////


#Work in Progress 

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Code
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
