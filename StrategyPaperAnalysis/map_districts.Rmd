---
title: "R Notebook"
output: html_notebook
---


```{r}
library(utils)
setwd("gis")
otimeout <- getOption("timeout")
options(timeout=1200)
# TODO: There is probably a better source. Extract from 3GB Inegi census?
download.file("https://pautas.ine.mx/transparencia/mapas/cob_2020/SECCION.zip","SECCION2.zip")
options(timeout=otimeout)
unzip("SECCION.zip")
```



```{r}
library("sf")
seccion_base.sf <- read_sf("gis/SECCION.shp", check_ring_dir=TRUE)
```

```{r}
library(tidyverse)
library(magrittr)
library(ggplot2)

i<-2
 

seccion_base.sf %>% filter(entidad==planFull.df[[i,"edon"]]) %>% 
  left_join(planFull.df[[i,"plan"]][[1]],by=c("seccion")) %>% mutate(district=factor(district)) %>%
  ggplot() + aes(fill=district) + geom_sf()


```

```{r}
j<-3  # this has the same edon -- otherwise it ain't comparable :-)

# assumes plans have same district numbering order -- TODO: reorder district numbers for best match before differencing
dcomp<- full_join(planFull.df[[i,"plan"]][[1]],planFull.df[[j,"plan"]][[1]],by=c("seccion")) %>% mutate(district.diff=district.x==district.y)

seccion_base.sf %>% filter(entidad==planFull.df[[i,"edon"]]) %>% 
  left_join(dcomp,by=c("seccion"))  %>%
  ggplot() + aes(fill=district.diff) + geom_sf()
```
```{r}
i<-2 ; j <- 3
plan_1.tbl <- planFull.df[[i,"plan"]][[1]]
plan_2.tbl <- planFull.df[[j,"plan"]][[1]]

dis_1.tbl <- plan_1.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))
dis_2.tbl <- plan_2.tbl %>% group_by(district) %>% summarize(seclist=list(seccion))

#example of calculating size differences between two different districts, without assuming numbering is the same
intersect(dis_1.tbl[1,"seclist"][[1]][[1]],dis_2.tbl[1,"seclist"][[1]][[1]])
```
