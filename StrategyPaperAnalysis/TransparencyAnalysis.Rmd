---
title: "Transparency Analysis"
output:
  html_notebook: default
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---
# Setup
```{r}
## Libraries
require(tidyverse)
require(tidylog)
require(gt)
require(grid)
require(egg)
require(gtable)
require(webshot)
options("tidylog.display" = list())  # turn off
```
```{r, include=FALSE}
## Bring in proposal event database
source("PrepData.R",verbose=FALSE)
```
```{r}
## Transparency data table
proptrans.df <- propfull.df
# TODO: Experiment with expss for labelling 
#proptrans.df %<>% set_value_labels(edon=setNames(statecodes.df$edon,as.list(statecodes.df$tla)))

proptrans.df %<>% rowwise() %>% mutate(hasplan=!is.null(plan)) # indicator for presence of plan spec in data
#proptrans.df %<>% select(-plan) # drop full plan tibble for computation efficiency since its big, and we don't use it further
proptrans.df %<>% mutate(year=as.integer(year))
proptrans.df %<>% rowwise() %>% mutate(VALIDPLAN=(is.na(INVALID)|!INVALID)&!is.na(PROPOSED)) 
proptrans.df %<>% rowwise() %>% mutate(rscore=(round(SCORE,digits=5))) # prevent plans not matching across stages because of rounding error
 proptrans.df %<>% rowwise() %>% mutate(planid=ifelse(is.na(rscore),NA,paste(rscore,edon,year,sep="-"))) # for network analysis
```
```{r}
## For the purpose of simplifying presentation of analysis recode {INE, Junta, CLV} -> Admin; PRD51 to PRD
## Note that PRD51 represents corrected proposals by PRD (after submitting invalid proposals)
## Junta, CLV, derfe are parts of INE
proptrans.df %<>% rowwise() %<>% mutate(actor2=case_when(actor=="PRD51"~"PRD", TRUE ~ actor))
proptrans.df %<>% rowwise() %>% mutate(actortype2=as.character(actortype), actortype2=if_else(actor2=="PRD","major",actortype2))
proptrans.df %<>% rowwise() %<>% mutate(actor2=ifelse(actor2 %in% c("Junta","CLV","derfe"),"INE",actor2))
```
```{r}
## create summary df of contest events (by  year, edon)
contestSum.df <-proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(2))) %>% group_by(year,edon) %>% summarize(phase2_plans=list(na.omit(rscore)))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(2)),actortype %in% c("major","minor")) %>% group_by(year,edon) %>% summarize(phase2_plans_party=list(na.omit(rscore))))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(4))) %>% group_by(year,edon) %>% summarize(phase4_plans=list(na.omit(rscore))))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(4)),actortype %in% c("major","minor")) %>% group_by(year,edon) %>% summarize(phase4_plans_party=list(na.omit(rscore))))


contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==3 ) %>% group_by(year,edon) %>% transmute(phase3_win=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==1 ) %>% group_by(year,edon) %>% transmute(phase1_start=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==5 ) %>% group_by(year,edon) %>% transmute(final_win=rscore))

# code off-cycle interventions
contestSum.df %<>% rowwise() %>% mutate(INEchanged_phase3 = !phase3_win %in% c(phase2_plans,phase1_start))
contestSum.df %<>% rowwise() %>% mutate(INEchanged_final = !final_win %in% c(phase4_plans,phase3_win))

# code for best scores
contestSum.df %<>% rowwise() %>% mutate(lowestvalid = min(phase1_start,phase2_plans,phase3_win,phase4_plans),phase2_lowest = min(phase1_start,phase2_plans),final_lowest=min(phase3_win,phase4_plans),best_lost=final_win!=lowestvalid)

# code for sec8 & rules violations
contestSum.df %<>% rowwise() %>% mutate(phase2_unanimous=(length(unique(phase2_plans_party))==1), final_unanimous=length(unique(phase4_plans_party))==1)
contestSum.df %<>% rowwise() %>% mutate( phase2_notlow = (phase3_win>min(phase2_lowest,phase1_start)), final_notlow = (final_win>min(final_lowest,phase3_win)))
contestSum.df %<>% rowwise() %>% mutate( phase2_section8 = ( phase2_notlow & phase2_unanimous ), final_section8 = ( final_notlow & final_unanimous )) 
contestSum.df %<>% rowwise() %>% mutate( phase2_violation = ( phase2_notlow & !phase2_unanimous ), final_violation = ( final_notlow & !final_unanimous )) 
```
```{r}
## Create Plan Data Structure
 planProp.df <- proptrans.df %>% filter(!is.na(planid)) %>% group_by(planid) %>% summarize(stages=list(sort(unique(stage))),rscore=unique(rscore),edon=unique(edon),year=unique(year),VALIDPLAN=unique(VALIDPLAN),tla=unique(tla))
planProp.df %<>% rowwise() %<>% mutate(win_final=(5 %in% stages))
planProp.df %<>% rowwise() %>% mutate(first_appeared=stages[[1]])

# finding creators is a nested op, breaking this up for readability
tmpCreators <- left_join(proptrans.df %>% filter(!is.na(planid)), planProp.df %>% select(planid,first_appeared)) %>% filter(stage==first_appeared) %>% group_by(planid) %>% summarize(creators=list(unique(actor2)))  
planProp.df %<>% left_join(tmpCreators)
rm(tmpCreators)

# fill in outcome characteristics
planProp.df %<>% left_join( contestSum.df %>% select( year, edon, lowestvalid, phase2_lowest, final_lowest, phase2_unanimous, final_unanimous, final_section8, final_violation ))
planProp.df %<>% mutate(unanimous_creator=(first_appeared==2 & phase2_unanimous) | (first_appeared==4 & final_unanimous) )
planProp.df %<>% mutate( best_plan = ( rscore==lowestvalid & VALIDPLAN ))
planProp.df %<>% mutate( win_section8 = win_final & final_section8)
planProp.df %<>% mutate( win_violation = win_final & final_violation)
planProp.df %<>% select( -lowestvalid, -phase2_lowest, -final_lowest, -phase2_unanimous, -final_unanimous, -final_section8, -final_violation )

# label by creator
# TODO: treat ADMIN types  CLV and Junta in other phases as admin
planProp.df %<>% rowwise() %>% mutate( creator_label = case_when(
    first_appeared ==1 ~ "ALGORITHM",
    first_appeared ==3 ~ "INE",
    first_appeared ==5 ~ "INE",
    length(creators)==1 ~ "SINGLE",# creators[[1]],
    (length(creators)>1 & unanimous_creator) ~ "UNANIMOUS",
    TRUE ~ "Coalition")
)
planProp.df %<>% rowwise() %>% mutate( creator_label = factor(creator_label))
planProp.df %<>% rowwise() %>% mutate( creator_coded = case_when(
    first_appeared ==1 ~ "ALGORITHM",
    first_appeared ==3 ~ "INE",
    first_appeared ==5 ~ "INE",
    length(creators)==1 ~ creators[[1]],
    (length(creators)>1 & unanimous_creator) ~ "UNANIMOUS",
    TRUE ~ "Coalition")
)
```
#Transparency Analysis
```{r}
##set themes for look and feel of tables

#TODO: explore use of gtsummary
#require(gtsummary)
#reset_gtsummary_theme()
#theme_gtsummary_journal(journal = "jama")
#heme_gtsummary_compact()

# from Mock (2020, Sept. 28). The Mockup Blog: Functions and Themes for gt tables. Retrieved from https://themockup.blog/posts/2020-09-26-functions-and-themes-for-gt-tables/

gt_theme_538 <- function(data,...) {
  data %>%
  opt_all_caps()  %>%
  opt_table_font(
    font = list(
      google_font("Chivo"),
      default_fonts()
    )
  ) %>%
    tab_style(
      style = cell_borders(
        sides = "bottom", color = "transparent", weight = px(2)
      ),
      locations = cells_body(
        columns = TRUE,
        # This is a relatively sneaky way of changing the bottom border
        # Regardless of data size
        rows = nrow(data$`_data`)
      )
    )  %>% 
  tab_options(
    column_labels.background.color = "white",
    table.border.top.width = px(3),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table.border.bottom.width = px(3),
    column_labels.border.top.width = px(3),
    column_labels.border.top.color = "transparent",
    column_labels.border.bottom.width = px(3),
    column_labels.border.bottom.color = "black",
    data_row.padding = px(3),
    source_notes.font.size = 12,
    table.font.size = 16,
    heading.align = "left",
    ...
  ) 
}
```
## Third Party Actors
*  All scored entries are in 2013
* Unspecificed actors - Junta, CLV, PRD51
* Plans are scored, but not included for ghostprop
* Also 2017 Jalisco plan by derfe/INE submitted but not officially scored
```{r}
thirdparty.tab <- proptrans.df %>% group_by(year,actor2) %>% summarise (
  outside=sum(PROPOSED & actortype2 %in% c("admin","other") & stage %in% c(2,4),na.rm=TRUE),
  missing=sum(!is.na(PROPOSED) & PROPOSED & !hasplan),
  unscored=sum(is.na(PROPOSED)& hasplan),
  grandtotal=outside+missing+unscored,
) 
thirdparty.tab %>% 
  filter(grandtotal>0) %>%
  select(-grandtotal) %>%
  gt()  %>%
  cols_label( "actor2" = "Actor","outside"="Admin Proposals","missing"="Missing Plans","unscored"="Proposals Not Scored" ) %>%
  tab_header(title="Undocumented Proposals") %>%
  tab_source_note(
    source_note = "Note: Admin proposals do not include interventions during decision phase to change plans." ) %>%
  data_color( 
      columns = vars(outside,missing,unscored), 
      colors = scales::col_numeric( 
      palette = c( "white","orange"), 
        domain = c(0,7) 
      )
  ) %>% 
  gt_theme_538() 
```
## Process Overview
```{r  fig.height=2, fig.width=10 }
procColors <- planProp.df %>% filter(VALIDPLAN) %>%
  scale_color_hue("creator_label",drop=FALSE)
zoom1<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2013, edon==15) %>% 
   ggplot(aes(x=stages,y=rscore,group=planid,color=creator_label))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.2,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+
    scale_color_hue("creator_label",drop=FALSE)+
  theme(axis.title.y=element_blank(),legend.title=element_blank(), legend.position="none")
zoom2<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2017, edon==19) %>% 
   ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.2,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+
    scale_color_hue("creator_label",drop=FALSE)+
  theme(axis.title.y=element_blank(),legend.title=element_blank(), 
        strip.background = element_rect(fill=alpha("blue",.3)),)
ggarrange(zoom1,zoom2,ncol=2)
rm(zoom1,zoom2) 

```

```{r fig.width=10, fig.height=10}
#plots
pl1<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2013, edon<16) %>% 
  ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid)) +geom_point()+geom_line()+geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+theme(legend.position = "none") +
    scale_color_hue("creator_label",drop=FALSE)
pl2<-planProp.df %>% filter(VALIDPLAN)  %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2017, edon<16) %>% 
   ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y") + theme(legend.position = "none", axis.title.y=element_blank(), strip.background =element_rect(fill=alpha("blue",.3)))+
    scale_color_hue("creator_label",drop=FALSE)
pl3<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2013, edon>=16) %>% 
  ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid)) +geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.3,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+theme(legend.position = "none",axis.title.y=element_blank()) +
    scale_color_hue("creator_label",drop=FALSE)
pl4<-planProp.df %>% filter(VALIDPLAN) %>% group_by(planid) %>% unnest(cols=stages) %>% filter(year==2017, edon>=16) %>% 
   ggplot(aes(x=stages,y=rscore,color=creator_label,group=planid))+geom_point()+geom_line()+ geom_vline(xintercept=c(2,4),alpha=.2,color="blue")+
  facet_grid(rows=vars(tla), cols=vars(year), scales="free_y")+theme(axis.title.y=element_blank(), legend.title=element_blank(),
strip.background =element_rect(fill=alpha("blue",.3))) +
    scale_color_hue("creator_label",drop=FALSE)
ggarrange(pl1,pl2,pl3,pl4,ncol=4)
rm(pl1,pl2,pl3,pl4) 
```
## Algorithmic Score Efficency 
```{r}
efficiency.df <- contestSum.df %>% rowwise() %>% mutate(efficiency=(1-(phase1_start-lowestvalid)/lowestvalid)*100) %>% select(year,edon,efficiency) %>% mutate(year=as.factor(year))
efficiency.df %>% group_by(year) %>% summarize(min_efficiency=min(efficiency),median_efficiency=median(efficiency), mean_efficiency=mean(efficiency))
efficiency.df %>% ggplot(aes(efficiency))+geom_histogram(bins=30)+facet_grid(rows=vars(year))
efficiency.df %>% ggplot(aes(x=edon,y=efficiency,fill=year))+geom_col(position="dodge", width=.5)
rm(efficiency.df)

planProp.df %>% filter(best_plan) %>% 
  group_by(creator_coded,year) %>% summarise(count=n(),percent=count/32) %>% 
  gt() %>% 
  tab_header(title="Best Scoring Plans by Creator") %>%
  cols_label( "creator_coded" = "Actor","count"="","percent"="" ) %>%
  fmt_percent(vars(percent)) %>%
   data_color (
      columns=vars(percent), 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
      domain = c(0,1) ) 
      ) %>%
  tab_source_note(
    source_note = "Note: Creators refers to initial plan creators, others may have joined in later rounds." ) %>%
  gt_theme_538() 


```
## Exceptional Events 
```{r}
res_events_grp.df <-
  planProp.df %>% group_by(year) %>% summarise(
      events = sum( !VALIDPLAN ) , 
      denominator = n(), type = "INE Invalidated Proposed Plan" , category="compliance"
  )

res_events_grp.df %<>% bind_rows(
   contestSum.df %>% group_by(year) %>% summarise(
      events = sum(final_section8) + sum(phase2_section8) , 
      denominator = n()*2, type = "Unanimous Higher Score Proposal Accepted" , category="compliance"
  )
)

res_events_grp.df %<>% bind_rows(
  contestSum.df %>% group_by(year) %>% summarise(
      events = sum(INEchanged_phase3) + sum(INEchanged_final) , 
      denominator = n()*2, type = "INE Modified proposals" , category="compliance"
  )
)

res_events_grp.df %<>% bind_rows(
  contestSum.df %>% group_by(year) %>% summarise(
      events = sum(phase2_violation) + sum(final_violation) , 
      denominator = n()*2, type = "Higher Score Plan Without Unanimity" , category="compliance"
  )
)

#TODO side by side groups?
res_events_grp.df %>% group_by(year) %>% summarize(
  type=type, 
  count=events,
  percent=count/denominator,
  ) %>%
  gt() %>% 
    cols_label( percent="" , "type"="","count"="") %>%
    fmt_percent(columns="percent") %>%
    tab_header(title="Process Exceptions") %>%
    tab_source_note( source_note = "Note: Exceptions are suspect, but not necessarily illegal." ) %>%
    data_color (
      columns = vars(percent), 
      colors = scales::col_numeric( 
      palette = c( "white","orange"), 
        domain = c(0,.25) ) 
    ) %>% 
    gt_theme_538() 

res_events_grp.df %>% group_by(year) %>% summarize(
  type=type, 
  count=events,
  percent=count/denominator,
  ) %>%
  pivot_wider(names_from=year,values_from=c(count,percent))%>%
  relocate(type,count_2013,percent_2013,count_2017,percent_2017) %>%
  gt() %>%
    cols_label( percent_2013="" , percent_2017="", "type"="","count_2013"="","count_2017"="") %>%
    fmt_percent(columns=c("percent_2013","percent_2017")) %>%
    tab_header(title="Process Exceptions") %>%
    tab_spanner(
      label = "2013",
      columns = vars(count_2013, percent_2013)
    ) %>%
    tab_spanner(
      label = "2017",
      columns = vars(count_2017, percent_2017)
    ) %>%
    tab_source_note( source_note = "Note: Exceptions are suspect, but not necessarily illegal." ) %>%
    data_color (
      columns = vars(percent_2013,percent_2017), 
      colors = scales::col_numeric( 
      palette = c( "white","orange"), 
        domain = c(0,.25) ) 
    ) %>% 
    gt_theme_538() 
```

## Outcome vs Expectations
- Best score won
- Algorithm won
- Lower score won without unanimity
- Section 8 won
```{r}
contestSum.df %>% group_by(year) %>%     
  summarize( 
    best_lost = sum(best_lost)/n(),
    algorithm_lost = sum(final_win!=phase1_start)/n(),
    section8_won = sum(final_section8)/n(),
    rules_violation = sum(final_violation)/n(),
  ) %>% group_by(year) %>%
 gt() %>%
    cols_label( algorithm_lost= "Algorithm  Lost", best_lost="Best Score Lost", 
                section8_won="Unanimous - Not Best", rules_violation="No Agreement & Not Best") %>%
    fmt_percent(2:5) %>%
    tab_header(title="Unexpected Winners") %>%
    tab_source_note( source_note = "Note:N=32 per year." ) %>%
    data_color (
      columns=2:5, 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,1) ) 
    ) %>% 
    gt_theme_538() 

planProp.df %>% filter(win_final) %>% 
  group_by(creator_coded,year) %>% summarize(wins=n(),percent=wins/32) %>%
  gt() %>% tab_header(title="Winning Plans by Creator") %>%
   cols_label( "creator_coded" = "Actor", "year"="","percent"="%") %>%
   fmt_percent(4) %>%
  data_color (
      columns=4, 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,1) ) 
    ) %>% 
  tab_source_note(
    source_note = "Note: Creators refers to initial plan creators, others may have joined in later rounds." ) %>%
  gt_theme_538()

```

## Exceptions by party
```{r}

res_outcomes_party.df <-
  planProp.df %>% group_by(year,creator_coded) %>% summarise(
      events = sum( !VALIDPLAN ) , 
      denominator = n(), type = "Invalidated" , category="compliance"
  )

# Not enough variation with coalitions... move this to a proportion/network analysis
# note denominator is number of contests in each year
#res_outcomes_party.df %<>% bind_rows(
#    planProp.df %>% group_by(year,creator_coded) %>% summarise(
#      events = sum( win_section8 ) , 
#      denominator = 32, type = "Won w Sec8" , category="compliance"
# )
#)

res_outcomes_party.df %<>% bind_rows(
    planProp.df %>% group_by(year,creator_coded) %>% summarise(
      events = sum( win_violation ) , 
      denominator = 32, type = "Won in Violation of Rules" , category="compliance"
  )
)

res_outcomes_party.df %<>% rowwise() %>% mutate(percent=events/denominator)

res_outcomes_party.df %>% 
  group_by(year,creator_coded) %>% relocate(type) %>% select(-denominator,-category) %>%
    filter(sum(events)>0) %>%
    gt() %>% 
    cols_label( percent="%", "type"="","events"="" ) %>%
    fmt_percent(columns="percent") %>%
    tab_header(title="Exceptions by Creator") %>%
    tab_source_note( source_note = "Note: Denominator for wins is 32 states/year. Denominator for invalidations is total proposals by that party." ) %>%
    data_color (
      columns = vars(percent), 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,.2) ) 
    ) %>% 
    gt_theme_538() 

```

## Disaggregated Analysis
```{r}
unrolled.df <-planProp.df  %>% unnest(creators)

ncontests <- 32
res_outcomes_unrolled.df <- 
  unrolled.df %>% 
  filter(win_final) %>% 
  mutate(denominator=ncontests) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Win", denominator=unique(denominator) )

res_outcomes_unrolled.df %<>% bind_rows(
  unrolled.df %>% 
  mutate(denominator=ncontests) %>% 
  filter(win_section8) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Win by sec 8", denominator=unique(denominator) )
)

res_outcomes_unrolled.df %<>% bind_rows(
  unrolled.df %>% 
  mutate(denominator=ncontests) %>% 
  filter(win_violation) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Win in violation of the rules", denominator=unique(denominator) )
)

res_outcomes_unrolled.df %<>% bind_rows(
  unrolled.df %>% 
  group_by(year) %>% mutate(denominator=length(unique(planid))) %>% 
  filter(!VALIDPLAN) %>% 
  group_by(year,creators) %>% 
  summarise(  events = n(), type = "Invalidated", denominator=unique(denominator) )
)

res_outcomes_unrolled.df %<>% rowwise() %>% mutate(percent=events/denominator)

res_outcomes_unrolled.df %>% 
  rowwise() %>% filter(type=="Win") %>%
  group_by(year,creators) %>% relocate(type) %>% select(-denominator) %>%
    filter(sum(events)>0) %>%
    gt() %>% 
    cols_label( percent="%","events"="" ) %>%
    fmt_percent(columns="percent") %>%
    tab_header(title="Wins by Invidual Creator") %>%
    tab_source_note( source_note = "Note: Percentages do not add up to 100% because plans have multiple creators. Denominator for win measures is 32/year. Denominator for invalidations is total proposals in that year." ) %>%
    data_color (
      columns = vars(percent), 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,.8) ) 
    ) %>% 
    gt_theme_538() 

res_outcomes_unrolled.df %>% 
  rowwise() %>% filter(type!="Win") %>%
  group_by(year,creators) %>% relocate(type) %>% select(-denominator) %>%
    filter(sum(events)>0) %>%
    gt() %>% 
    cols_label( percent="%","events"="" ) %>%
    fmt_percent(columns="percent") %>%
    tab_header(title="Exceptions by Invidual Creator") %>%
    tab_source_note( source_note = "Note: Percentages do not add up to 100% because plans have multiple creators. Denominator for win measures is 32/year. Denominator for invalidations is total proposals in that year." ) %>%
    data_color (
      columns = vars(percent), 
      colors = scales::col_numeric( 
      palette = c( "white","red"), 
        domain = c(0,.8) ) 
    ) %>% 
    gt_theme_538()




```
##  Exploratory Network Analysis
```{r fig.width=10, fig.height=4}
require(DiagrammeR)
require(tidygraph)
require(igraph)
require(ggraph)


actorsnodes.df <- actors.df  %>% filter(!actor %in% c("Junta","derfe","CLV","PRD51")) %>% mutate(id=1:n()) %>% mutate(label=actor) %>% relocate(id,label)
actorsedges.df <-planProp.df %>% select(planid, creators, win_final, win_section8, win_violation, VALIDPLAN) %>% unnest(creators)
actorsedges.df %<>% left_join(actorsnodes.df,by=c("creators"="actor")) %>% select(-label,-actortype) %>% rename("creator_id"="id")
actorsedges.df %<>% left_join(actorsedges.df %>% select(planid,creator_id), by="planid") %>% 
  rename("from"="creator_id.x","to"="creator_id.y") 
actorsedges.df %<>%  
  filter(to!=from) %>%  
  mutate (id=1:n() , 
          weight = ifelse(win_final,1,.5),
          color = ifelse(win_final,"red","black"),
          rel = ifelse(win_final,"win","lose") 
          ) %>%
  relocate(id,to,from,weight,color,rel)
    

plan.graph <-create_graph( nodes_df= actorsnodes.df, edges_df = actorsedges.df, graph_name="Actors Proposing Together")

#plan.graph %>% render_graph(layout="circle")
# can also use this an igraph or tidygraph object
plan.igraph <- to_igraph(plan.graph)
plan.tgraph <- as_tbl_graph(plan.igraph)
plan.tgraph %>% ggraph() +
    geom_edge_fan(aes(color=factor(rel)),alpha=.2) +
    #geom_edge_density(fill="blue") +
  geom_node_label(aes(label=actor,color=factor(actortype)))


```

Preparing the Vote Share Data
```{r}
#TODO: Import data thru the repository; 

#Uploads Vraw files directly from Eric's githib page (need to change the source so that it is in the Github repository)
url.file <- "https://raw.githubusercontent.com/emagar/mxDistritos/master/data/dipfed-seccion-vraw-2018.csv"
Vraw.2018 <- read.csv(url(url.file))

#Adds votes received by coalition groups to the major party with which the coalition is associated.
Vraw.2018 <- Vraw.2018 %>%
  mutate(pan = pan + panc) %>%
  mutate(pri = pri + pric) %>%
  mutate(morena = morena + morenac) %>%
  select(., -panc, -pric, -morenac) #drop the unneeded rows

#Data is in wide format, converts the data to long format
Vraw.2018 %<>% pivot_longer(., cols = c("pan", "pri", "prd", "pvem", "pt", "mc", "pna", "morena", "pes"),
                            names_to = "actor",
                            values_to = "votes_2018")
#Converts the actor names to uppercase to match with actor names in subsequent dataframes
Vraw.2018 <- Vraw.2018 %>%
  mutate(actor = toupper(actor))

###The Same process is done for Vraw 2015 in the following code

#Create a column for actor (to more easily merge with other datasets), votes are values associated w/ each actor category
url.file <- "https://raw.githubusercontent.com/emagar/mxDistritos/master/data/dipfed-seccion-vraw-2015.csv"
Vraw.2015 <- read.csv(url(url.file))

Vraw.2015 <- Vraw.2015 %>%
  mutate(prd = prd + prdc) %>%
  mutate(pri = pri + pric) %>%
  select(., -ph, -prdc, -pric)

Vraw.2015 %<>% pivot_longer(., cols = c("pan", "pri", "prd", "pvem", "pt", "mc", "pna", "morena", "pes"),
                            names_to = "actor",
                            values_to = "votes_2015")
Vraw.2015 <- Vraw.2015 %>%
  mutate(actor = toupper(actor))


```

```{r}

test.df <- left_join(planProp.df, proptrans.df, by = c("planid"))


#Filter for only the "best plans" (those with the lowest score)
test.df <- test.df %>%
  filter(best_plan == TRUE) %>%
  unnest(plan) #unnest the "plan" variable so that the vote share data can be merged at the seccion level

#Select plans that occurred in 2013, rename variables to match the Vote share data
test13.df <- test.df %>%
  filter(year.x == 2013) %>%
  rename(disn = district,
         edon = edon.x)

#Merge the vote share with the data for the proposals
test13.df <- left_join(test13.df, Vraw.2015, by = c("edon", "disn", "seccion"))

#Sums vote data by each district and computes the vote share. 
test13.df %<>% na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2015 = sum(votes_2015),
            lisnom_2015 = sum(lisnom),
            efec_2015 = sum(efec),
            dprdc_2015 = sum(dprdc),
            dpric_2015 = sum(dpric)) %>%
  mutate(VoteShare_2015 = (votes_2015/efec_2015)*100,
         dprdc = if_else(dprdc_2015 > 0, 1, 0),
         dpric = if_else(dpric_2015 > 0, 1, 0),
         Max_VS = max(VoteShare_2015),
         Seat_Win_0 = if_else(VoteShare_2015 == Max_VS, 1, 0)) %>% #Registers which party won the district (Having the highest Vote Share in the district --> winning the seat)
  select(., -dprdc_2015, - dpric_2015, -Max_VS) %>%
  rename(actor = actor.y)


### These steps are repeated for subsequent categories of plans (plans with section 8 violations, rule violations, and finally, plans which were adopted)
####

test.df_1 <- left_join(planProp.df, proptrans.df, by = c("planid"))

#Filters for plans that won due to section 8 violations
test.df_1 <- test.df_1 %>%
  filter(win_section8 == TRUE) %>%
  unnest(plan)

test13.df_1 <- test.df_1 %>%
  filter(year.x == 2013) %>%
  rename(disn = district,
         edon = edon.x)
test13.df_1 <- left_join(test13.df_1, Vraw.2015, by = c("edon", "disn", "seccion"))
test13.df_1 %<>% na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2015 = sum(votes_2015),
            lisnom_2015 = sum(lisnom),
            efec_2015 = sum(efec),
            dprdc_2015 = sum(dprdc),
            dpric_2015 = sum(dpric)) %>%
  mutate(VoteShare_2015 = (votes_2015/efec_2015)*100,
         dprdc = if_else(dprdc_2015 > 0, 1, 0),
         dpric = if_else(dpric_2015 > 0, 1, 0),
         Max_VS = max(VoteShare_2015),
         Seat_Win_1 = if_else(VoteShare_2015 == Max_VS, 1, 0)) %>%
  select(., -dprdc_2015, - dpric_2015, -Max_VS) %>%
  rename(actor = actor.y)


###
test.df_2 <- left_join(planProp.df, proptrans.df, by = c("planid"))

#Filters for plans that won due to rule violations
test.df_2 <- test.df_2 %>%
  filter(win_violation == TRUE) %>%
  unnest(plan)

test13.df_2 <- test.df_2 %>%
  filter(year.x == 2013) %>%
  rename(disn = district,
         edon = edon.x)
test13.df_2 <- left_join(test13.df_2, Vraw.2015, by = c("edon", "disn", "seccion"))
test13.df_2 %<>% na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2015 = sum(votes_2015),
            lisnom_2015 = sum(lisnom),
            efec_2015 = sum(efec),
            dprdc_2015 = sum(dprdc),
            dpric_2015 = sum(dpric)) %>%
  mutate(VoteShare_2015 = (votes_2015/efec_2015)*100,
         dprdc = if_else(dprdc_2015 > 0, 1, 0),
         dpric = if_else(dpric_2015 > 0, 1, 0),
         Max_VS = max(VoteShare_2015),
         Seat_Win_2 = if_else(VoteShare_2015 == Max_VS, 1, 0)) %>%
  select(., -dprdc_2015, - dpric_2015, -Max_VS) %>%
  rename(actor = actor.y)

###
test.df_3 <- left_join(planProp.df, proptrans.df, by = c("planid"))

#Filters for plans that won at the end  of the process (regardless of how they won (best plan, section 8, rule violation))
test.df_3 <- test.df_3 %>%
  filter(win_final == TRUE) %>%
  unnest(plan)

test13.df_3 <- test.df_3 %>%
  filter(year.x == 2013) %>%
  rename(disn = district,
         edon = edon.x)
test13.df_3 <- left_join(test13.df_3, Vraw.2015, by = c("edon", "disn", "seccion"))
test13.df_3 %<>% na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2015 = sum(votes_2015),
            lisnom_2015 = sum(lisnom),
            efec_2015 = sum(efec),
            dprdc_2015 = sum(dprdc),
            dpric_2015 = sum(dpric)) %>%
  mutate(VoteShare_2015 = (votes_2015/efec_2015)*100,
         dprdc = if_else(dprdc_2015 > 0, 1, 0),
         dpric = if_else(dpric_2015 > 0, 1, 0),
         Max_VS = max(VoteShare_2015),
         Seat_Win_3 = if_else(VoteShare_2015 == Max_VS, 1, 0)) %>%
  select(., -dprdc_2015, - dpric_2015, -Max_VS) %>%
  rename(actor = actor.y)

##
#Regenerates the Vote Share data in the long form and computes vote share and seat wins by party 
url.file <- "https://raw.githubusercontent.com/emagar/mxDistritos/master/data/dipfed-seccion-vraw-2015.csv"
Vraw.2015 <- read.csv(url(url.file))

Vraw.2015 <- Vraw.2015 %>%
  mutate(prd = prd + prdc) %>%
  mutate(pri = pri + pric) %>%
  select(., -ph, -prdc, -pric)

Vraw.2015 %<>% pivot_longer(., cols = c("pan", "pri", "prd", "pvem", "pt", "mc", "pna", "morena", "pes"),
                            names_to = "actor",
                            values_to = "votes_2015")
Vraw.2015 <- Vraw.2015 %>%
  mutate(actor = toupper(actor))

Vraw.2015 %<>% na.omit() %>%
  group_by(edon, disn, actor) %>%
  summarise(., votes_2015 = sum(votes_2015),
            lisnom_2015 = sum(lisnom),
            efec_2015 = sum(efec),
            dprdc_2015 = sum(dprdc),
            dpric_2015 = sum(dpric)) %>%
  mutate(VoteShare_2015 = (votes_2015/efec_2015)*100,
         dprdc = if_else(dprdc_2015 > 0, 1, 0),
         dpric = if_else(dpric_2015 > 0, 1, 0)) %>%
  select(., -dprdc_2015, - dpric_2015)

Vraw.2015 %<>% as_tibble() %>%
  group_by(edon, disn) %>%
  mutate(Max_VS = max(VoteShare_2015),
         Seat_Win = if_else(VoteShare_2015 == Max_VS, 1, 0)) %>%
  select(., -Max_VS)

#Using the Vraw datafram as a base, merges the dataframes from directly above which record the seat wins by party by district under the different win plan adoption conditions
test13.final.df <- left_join(Vraw.2015, test13.df, by = c("edon", "disn", "actor"))
test13.final.df <- left_join(test13.final.df, test13.df_1, by = c("edon", "disn", "actor"))
test13.final.df <- left_join(test13.final.df, test13.df_2, by = c("edon", "disn", "actor"))
test13.final.df <- left_join(test13.final.df, test13.df_3, by = c("edon", "disn", "actor"))


#Selects for the columns which record the seat wins under the different adoption conditons (as well as state, district, actor)
test.final.simplified <- test13.final.df %>%
  select(edon, disn, actor, Seat_Win, Seat_Win_0, Seat_Win_1, Seat_Win_2, Seat_Win_3)%>%
  mutate(Seat_Win_0 = coalesce(Seat_Win_0, Seat_Win),
         Seat_Win_1 = coalesce(Seat_Win_1, Seat_Win),
         Seat_Win_2 = coalesce(Seat_Win_2, Seat_Win), #Coalesce imputes the value from one row into another
         Seat_Win_3 = coalesce(Seat_Win_3, Seat_Win)) #Assumes that where plans do not propose a change to the electoral districts, they remain the same --> 
                                                      #the party that won the seat remains the same in that case

#Generates the final table that i have shown at meetings
test.final.simplified %>%
  group_by(actor) %>%
  summarise_at(vars(Seat_Win, Seat_Win_0, Seat_Win_1, Seat_Win_2, Seat_Win_3), list(sum)) %>%
  rename(Results_2015 = Seat_Win, Best_Plan = Seat_Win_0, Section_8 = Seat_Win_1, Rule_Violation = Seat_Win_2, Final = Seat_Win_3)-> table_
  #######################
test.df <- left_join(planProp.df, proptrans.df, by = c("planid"))

test.df <- test.df %>%
  filter(best_plan == TRUE) %>%
  unnest(plan)

test17.df <- test.df %>%
  filter(year.x == 2017) %>%
  rename(disn = district,
         edon = edon.x)
test17.df <- left_join(test17.df, Vraw.2018, by = c("edon", "disn", "seccion"))

test17.df %<>% select(., -INVALID, -PAPER) %>%
  na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2018 = sum(votes_2018),
            lisnom_2018 = sum(lisnom),
            efec_2018 = sum(efec),
            dpanc_2018 = sum(dpanc),
            dpric_2018 = sum(dpric),
            dmorenac_2018 = sum(dmorenac)) %>%
  mutate(VoteShare_2018 = (votes_2018/efec_2018)*100,
         dpanc = if_else(dpanc_2018 > 0, 1, 0),
          dpric = if_else(dpric_2018 > 0, 1, 0),
         dmorena = if_else(dmorenac_2018 > 0, 1, 0),
          Max_VS = max(VoteShare_2018),
         Seat_Win_0 = if_else(VoteShare_2018 == Max_VS, 1, 0)) %>%
  select(., -dpanc_2018, -dpric_2018, -dmorenac_2018) %>%
  rename(actor = actor.y)

####

test.df_1 <- left_join(planProp.df, proptrans.df, by = c("planid"))

test.df_1 <- test.df_1 %>%
  filter(win_section8 == TRUE) %>%
  unnest(plan)

test17.df_1 <- test.df_1 %>%
  filter(year.x == 2017) %>%
  rename(disn = district,
         edon = edon.x)
test17.df_1 <- left_join(test17.df_1, Vraw.2018, by = c("edon", "disn", "seccion"))
test17.df_1 %<>% select(., -INVALID, -PAPER) %>%
  na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2018 = sum(votes_2018),
            lisnom_2018 = sum(lisnom),
            efec_2018 = sum(efec),
            dpanc_2018 = sum(dpanc),
            dpric_2018 = sum(dpric),
            dmorenac_2018 = sum(dmorenac)) %>%
  mutate(VoteShare_2018 = (votes_2018/efec_2018)*100,
         dpanc = if_else(dpanc_2018 > 0, 1, 0),
         dpric = if_else(dpric_2018 > 0, 1, 0),
         dmorena = if_else(dmorenac_2018 > 0, 1, 0),
         Max_VS = max(VoteShare_2018),
         Seat_Win_1 = if_else(VoteShare_2018 == Max_VS, 1, 0)) %>%
  select(., -dpanc_2018, - dpric_2018, -dmorenac_2018, -Max_VS) %>%
  rename(actor = actor.y)


###
test.df_2 <- left_join(planProp.df, proptrans.df, by = c("planid"))

test.df_2 <- test.df_2 %>%
  filter(win_violation == TRUE) %>%
  unnest(plan)

test17.df_2 <- test.df_2 %>%
  filter(year.x == 2017) %>%
  rename(disn = district,
         edon = edon.x)
test17.df_2 <- left_join(test17.df_2, Vraw.2018, by = c("edon", "disn", "seccion"))
test17.df_2 %<>% select(., -INVALID, -PAPER) %>%
  na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2018 = sum(votes_2018),
            lisnom_2018 = sum(lisnom),
            efec_2018 = sum(efec),
            dpanc_2018 = sum(dpanc),
            dpric_2018 = sum(dpric),
            dmorenac_2018 = sum(dmorenac)) %>%
  mutate(VoteShare_2018 = (votes_2018/efec_2018)*100,
         dpanc = if_else(dpanc_2018 > 0, 1, 0),
         dpric = if_else(dpric_2018 > 0, 1, 0),
         dmorena = if_else(dmorenac_2018 > 0, 1, 0),
         Max_VS = max(VoteShare_2018),
         Seat_Win_2 = if_else(VoteShare_2018 == Max_VS, 1, 0)) %>%
  select(., -dpanc_2018, - dpric_2018, -dmorenac_2018, -Max_VS) %>%
  rename(actor = actor.y)

###
test.df_3 <- left_join(planProp.df, proptrans.df, by = c("planid"))

test.df_3 <- test.df_3 %>%
  filter(win_final == TRUE) %>%
  unnest(plan)

test17.df_3 <- test.df_3 %>%
  filter(year.x == 2017) %>%
  rename(disn = district,
         edon = edon.x)
test17.df_3 <- left_join(test17.df_3, Vraw.2018, by = c("edon", "disn", "seccion"))
test17.df_3 %<>% select(., -INVALID, -PAPER) %>%
  na.omit() %>%
  group_by(planid, edon, disn, actor.y) %>%
  summarise(., votes_2018 = sum(votes_2018),
            lisnom_2018 = sum(lisnom),
            efec_2018 = sum(efec),
            dpanc_2018 = sum(dpanc),
            dpric_2018 = sum(dpric),
            dmorenac_2018 = sum(dmorenac)) %>%
  mutate(VoteShare_2018 = (votes_2018/efec_2018)*100,
         dpanc = if_else(dpanc_2018 > 0, 1, 0),
         dpric = if_else(dpric_2018 > 0, 1, 0),
         dmorena = if_else(dmorenac_2018 > 0, 1, 0),
         Max_VS = max(VoteShare_2018),
         Seat_Win_3 = if_else(VoteShare_2018 == Max_VS, 1, 0)) %>%
  select(.,  -dpanc_2018, - dpric_2018, -dmorenac_2018, -Max_VS) %>%
  rename(actor = actor.y)

##
url.file <- "https://raw.githubusercontent.com/emagar/mxDistritos/master/data/dipfed-seccion-vraw-2018.csv"
Vraw.2018 <- read.csv(url(url.file))

Vraw.2018 <- Vraw.2018 %>%
  mutate(pan = pan + panc) %>%
  mutate(pri = pri + pric) %>%
  mutate(morena = morena + morenac) %>%
  select(., -panc, -pric, -morenac)

Vraw.2018 %<>% pivot_longer(., cols = c("pan", "pri", "prd", "pvem", "pt", "mc", "pna", "morena", "pes"),
                            names_to = "actor",
                            values_to = "votes_2018")
Vraw.2018 <- Vraw.2018 %>%
  mutate(actor = toupper(actor))

#Aggregate numbers by district and
#Generate values for vote share by actor
Vraw.2018 %<>% na.omit() %>%
  group_by(edon, disn, actor) %>%
  summarise(., votes_2018 = sum(votes_2018),
            lisnom_2018 = sum(lisnom),
            efec_2018 = sum(efec),
            dpanc_2018 = sum(dpanc),
            dpric_2018 = sum(dpric),
            dmorenac_2018 = sum(dmorenac)) %>%
  mutate(VoteShare_2018 = (votes_2018/efec_2018)*100,
         dpanc = if_else(dpanc_2018 > 0, 1, 0),
         dpric = if_else(dpric_2018 > 0, 1, 0),
         dmorena = if_else(dmorenac_2018 > 0, 1, 0)) %>%
  select(., -dpanc_2018, - dpric_2018, -dmorenac_2018)

Vraw.2018 %<>% as_tibble() %>%
  group_by(edon, disn) %>%
  mutate(Max_VS = max(VoteShare_2018),
         Seat_Win = if_else(VoteShare_2018 == Max_VS, 1, 0)) %>%
  select(., -Max_VS)

test17.final.df <- left_join(Vraw.2018, test17.df, by = c("edon", "disn", "actor"))
test17.final.df <- left_join(test17.final.df, test17.df_1, by = c("edon", "disn", "actor"))
test17.final.df <- left_join(test17.final.df, test17.df_2, by = c("edon", "disn", "actor"))
test17.final.df <- left_join(test17.final.df, test17.df_3, by = c("edon", "disn", "actor"))

test.final.simplified_2 <- test17.final.df %>%
  select(edon, disn, actor, Seat_Win, Seat_Win_0, Seat_Win_1, Seat_Win_2, Seat_Win_3) %>%
  mutate(Seat_Win_0 = coalesce(Seat_Win_0, Seat_Win),
         Seat_Win_1 = coalesce(Seat_Win_1, Seat_Win),
         Seat_Win_2 = coalesce(Seat_Win_2, Seat_Win),
         Seat_Win_3 = coalesce(Seat_Win_3, Seat_Win))

test.final.simplified_2 %>%
  group_by(actor) %>%
  summarise_at(vars(Seat_Win, Seat_Win_0, Seat_Win_1, Seat_Win_2, Seat_Win_3), list(sum)) %>%
  rename(Results_2018 = Seat_Win, Best_Plan = Seat_Win_0, Section_8 = Seat_Win_1, Rule_Violation = Seat_Win_2, Final = Seat_Win_3)-> table17_
  gt()

#Table:
# Filter out Table 4 row 3 and 4 as the violations
# Min scores in cases where these violations
#Unnest
#planscore functions.r, return a list

#Table:
# filter Ruke violations true
# Who proposed the rule violations where rule  violations -- did PRI propose and benefit?
```


IGNORE THIS FOR NOW
#Merge with the planProp data frame
```{r}
VS_R8.df <- left_join(contestSum.df, Vraw_df, by = c("edon"))
VS_R82.df <- left_join(planProp.df, Vraw_df, by = c("edon"))

VS_R8_chart1 <- VS_R8.df %>%
  group_by(edon, actor, year) %>%
  summarise(events1 = sum(final_section8) + sum(phase2_section8),
            demoninator = n()*2,
            VS15 = mean(VoteShare_2015),
            VS18 = mean(VoteShare_2018),
            Seats15 = sum(Seat_Win_2015),
            Seats18 = sum(Seat_Win_2018),
            type = "Unanimous Higher Score Proposal Accepted",
            category="compliance")
VS_R8_chart1 <- VS_R8_chart1 %>% as_tibble()

VS_R8_chart2 <- VS_R82.df %>%
  group_by(edon, actor, year) %>%
  summarise(events1 = sum( !VALIDPLAN ),
            demoninator = n()*2,
            VS15 = mean(VoteShare_2015),
            VS18 = mean(VoteShare_2018),
            Seats15 = sum(Seat_Win_2015),
            Seats18 = sum(Seat_Win_2018),
            type = "INE Invalidated Proposed Plan",
            category="compliance")
VS_R8_chart2 <- VS_R8_chart2 %>% as_tibble()
VS_R8_chart2 %>%
  group_by(year) %>%
  summarise(., sum(Seats15))
VS_R8_chart3 <- VS_R8.df %>%
  group_by(edon, actor, year) %>%
  summarise(events1 = sum(INEchanged_phase3) + sum(INEchanged_final),
            demoninator = n()*2,
            VS15 = mean(VoteShare_2015),
            VS18 = mean(VoteShare_2018),
            Seats15 = sum(Seat_Win_2015),
            Seats18 = sum(Seat_Win_2018),
            type = "INE Modified proposals",
            category="compliance")
VS_R8_chart3 <- VS_R8_chart3 %>% as_tibble()
VS_R8_chart3 %>%
  group_by(year) %>%
  summarise(., sum(Seats15))
VS_R8_chart4 <- VS_R8.df %>%
  group_by(edon, actor, year) %>%
  summarise(events1 = sum(phase2_violation) + sum(final_violation),
            demoninator = n()*2,
            VS15 = mean(VoteShare_2015),
            VS18 = mean(VoteShare_2018),
            Seats15 = sum(Seat_Win_2015),
            Seats18 = sum(Seat_Win_2018),
            type = "Higher Score Plan Without Unanimity",
            category="compliance")
VS_R8_chart4 <- VS_R8_chart4 %>% as_tibble()
VS_R8_chart4 %>%
  group_by(year) %>%
  summarise(., sum(Seats15))

#Filter out obv w/o violations
VS_R8_master.df <- rbind(VS_R8_chart1, VS_R8_chart3, VS_R8_chart4)
VS_R8_master.df %<>% mutate(violation = if_else(events1 > 0, TRUE, FALSE))

VS_R8_master.df %>%
  group_by(year, actor) %>%
  summarise(., mean(VS15), mean(VS18), sum(events1), denominator = n()*2) %>%
  gt()

VS_R8_master.df %>%
  filter(year == 2013) %>%
  group_by(actor, violation) %>%
  summarise(., round(sum(Seats15)/3), digits = 1) %>%
  gt()

VS_R8_master.df %>%
  filter(year == 2017) %>%
  group_by(actor, violation) %>%
  summarise(., round(sum(Seats18)/3), digits = 1) %>%
  gt()

#2013-2015
#No-violation (% share for each party overall) vs. violation -- groups
#BY party
#SEATS

#2017-2018
#no-violation vs. violation -- groups
#BY party
#SEATS

# actor, seat distribution
```



