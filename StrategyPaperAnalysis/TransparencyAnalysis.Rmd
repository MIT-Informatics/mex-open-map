---
title: "Transparency Analysis"
output: html_notebook
---

# Transparency Analysis (Sec. 4 tables)
```{r}
## Libraries
require(tidyverse)
require(tidylog)
require(gt)
options("tidylog.display" = list())  # turn off
```
```{r, include=FALSE}
## Bring in proposal event database
source("PrepData.R",verbose=FALSE)

```
```{r}
## Transparency data table
proptrans.df <- propfull.df
proptrans.df %<>% rowwise() %>% mutate(hasplan=!is.null(plan)) # indicator for presence of plan spec in data
proptrans.df %<>% select(-plan) # drop full plan sopec for computation efficiency since its big, and we don't use it further
proptrans.df %<>% rowwise() %>% mutate(VALIDPLAN=(is.na(INVALID)|!INVALID))
proptrans.df %<>% rowwise() %>% mutate(rscore=(round(SCORE,digits=5))) # prevent plans not matching across stages because of rounding error
 proptrans.df %<>% rowwise() %>% mutate(planid=ifelse(is.na(rscore),NA,paste(rscore,edon,year,sep="-"))) # for network analysis

```

## Preliminary Diagnostics
```{r}
# diagnostic frequency table -- not in publication
results<-proptrans.df%>% xtabs(PROPOSED~actor+govlevel+year+stage,data=.)
ftable(results)
```
## Invalidations 
```{r}
# Table 4.1 for Row 1
res_events_grp.df <- proptrans.df %>% filter(actortype=="minor" | actortype=="major") %>% group_by(year) %>% summarise(events=sum(!VALIDPLAN),denominator=sum(PROPOSED,na.rm=TRUE),type="plan invalidations",category="compliance") 
res_events_grp.df %>% pivot_wider(names_from=year,values_from=c(events,denominator))  %>% group_by(category) %>% gt()  %>% tab_header(title = "Compliance Events Summary" ) 

# Table 4.2 Col 1:2
res_events_actors.df <- proptrans.df %>% filter(actortype=="minor" | actortype=="major") %>% group_by(year,actor) %>% summarise(events=sum(!VALIDPLAN),denominator=sum(PROPOSED,na.rm=TRUE),category="compliance")
res_events_actors.df %>% gt()

```
## Third Party Actors
*  All scored entries are in 2013
*  Three unknown actors - Junta, CLV, PRD51
*  Plans are scored, but not included
*  Also 2017 Jalisco plan by derfe submitted but not officially scored
```{r}
thirdpartyprop.df <-propfull.df %>% filter(actortype!="minor" & actortype!="major") %>% filter(stage==2 | stage==4) %>% filter(PROPOSED==TRUE)

# Table 4.1 R2
thirdpartyprop.df %>% group_by(year,actor) %>% summarise(ghostproposals=sum(PROPOSED,na.rm=TRUE))

```
## INE Interventions
```{r}
## aggregate proposal lists  by  year, edon
contestSum.df <-proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(2))) %>% group_by(year,edon) %>% summarize(phase2_plans=list(na.omit(rscore)))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(4))) %>% group_by(year,edon) %>% summarize(phase4_plans=list(na.omit(rscore))))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==3 & actor=="INE") %>% group_by(year,edon) %>% transmute(phase3_win=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==1 & actor=="Algorithm") %>% group_by(year,edon) %>% transmute(phase1_start=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==5 & actor=="INE") %>% group_by(year,edon) %>% transmute(final_win=rscore))
```
```{r}
## INE interventions
contestSum.df %<>% rowwise() %>% mutate(INEchanged_phase3 = !phase3_win %in% c(phase2_plans,phase1_start))
contestSum.df %<>% rowwise() %>% mutate(INEchanged_final = !final_win %in% c(phase4_plans,phase3_win))
contestSum.df %>% group_by(year) %>% summarize(intervene_start=sum(INEchanged_phase3),intervene_final=sum(INEchanged_final))
```


## Winning Plan Not Lowest Scoring Valid Plan
## Section 8 

```{r}
contestSum.df %<>% rowwise() %>% mutate(lowestvalid = min(phase1_start,phase2_plans,phase3_win,phase4_plans),phase2_lowest = min(phase1_start,phase2_plans),final_lowest=min(phase1_start,phase2_plans,phase3_win),best_lost=final_win!=lowestvalid)
contestSum.df %<>% rowwise() %>% mutate(phase2_unanimous=(length(unique(phase2_plans))==1), final_unanimous=length(unique(phase4_plans))==1,section_eight=(final_unanimous&best_lost))
contestSum.df %>% group_by(year) %>% summarize(best_lost=sum(best_lost),section_eight=sum(section_eight))
```
## Rules Violations
```{r}


```
## Algorithmic Efficency 
```{r}
contestSum.df %<>% rowwise() %>% mutate(efficiency=(1-(phase1_start-lowestvalid)/lowestvalid)*100)
contestSum.df %>% group_by(year) %>% summarize(min_efficiency=min(efficiency),median_efficiency=median(efficiency), mean_efficiency=mean(efficiency))
contestSum.df %>% ggplot(aes(efficiency))+geom_histogram(bins=30)+facet_grid(rows=vars(year))
contestSum.df %>% ggplot(aes(x=edon,y=efficiency,fill=as.factor(year)))+geom_col(position="dodge", width=.5)
```
## Party Plan Breakdown
```{r}
## Create Plan Data Structure
 planProp.df <- proptrans.df %>% filter(!is.na(planid)) %>% group_by(planid) %>% summarize(stages=list(sort(unique(stage))),rscore=unique(rscore),edon=unique(edon),year=unique(year),VALIDPLAN=unique(VALIDPLAN))
planProp.df %<>% rowwise() %<>% mutate(win_final=(5 %in% stages))
planProp.df %<>% rowwise() %>% mutate(first_appeared=stages[[1]])

# finding creators is a nested op, breaking this up for readability
tmpCreators <- left_join(proptrans.df %>% filter(!is.na(planid)), planProp.df %>% select(planid,first_appeared)) %>% filter(stage==first_appeared) %>% group_by(planid) %>% summarize(creators=list(unique(actor)))  
planProp.df %<>% left_join(tmpCreators)
rm(tmpCreators)

# fill in outcome characteristics
planProp.df %<>% left_join( contestSum.df %>% select( year, edon, lowestvalid, phase2_lowest, final_lowest, phase2_unanimous, final_unanimous ))
planProp.df %<>% mutate(unanimous_creator=(first_appeared==2 & phase2_unanimous) | (first_appeared==4 & final_unanimous) )
planProp.df %<>% mutate( best_plan = ( rscore==lowestvalid ))
planProp.df %<>% select( -lowestvalid, -phase2_lowest, -final_lowest, -phase2_unanimous, -final_unanimous )

# label by creator
planProp.df %<>% rowwise() %>% mutate( creator_label=ifelse((length(creators)>1 & unanimous_creator), "unanimous", paste(creators,sep="-",collapse="-")))

planProp.df %<>% rowwise() %>% mutate( creator_label = case_when(
    first_appeared ==1 ~ "ALGORITHM",
    first_appeared ==3 ~ "INE",
    first_appeared ==5 ~ "INE",
    length(creators)==1 ~ "SINGLE",# creators[[1]],
    (length(creators)>1 & unanimous_creator) ~ "UNANIMOUS",
    TRUE ~ "Coalition")
)
```
```{r}
#plots
planProp.df %>% group_by(planid) %>% unnest(cols=stages) %>% #ggplot(aes(x=stages,y=rscore,color=creator_label))+geom_point()+geom_line()+
#  facet_grid(rows=vars(edon), cols=vars(year), scales="free_y")
ggplot(aes(x=stages,y=rscore,color=creator_label))+geom_point()+geom_line()+
  facet_wrap(facets=~year+edon, scales="free_y")


```



