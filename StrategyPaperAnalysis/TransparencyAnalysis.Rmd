---
title: "Transparency Analysis"
output: html_notebook
---

# Transparency Analysis (Sec. 4 tables)
```{r}
## Libraries
require(tidyverse)
require(tidylog)
require(gt)
options("tidylog.display" = list())  # turn off
```
```{r, include=FALSE}
## Bring in proposal event database
source("PrepData.R",verbose=FALSE)

```
```{r}
## Transparency data table
proptrans.df <- propfull.df
proptrans.df %<>% rowwise() %>% mutate(hasplan=!is.null(plan)) # indicator for presence of plan spec in data
proptrans.df %<>% select(-plan) # drop full plan sopec for computation efficiency since its big, and we don't use it further
proptrans.df %<>% rowwise() %>% mutate(VALIDPLAN=(is.na(INVALID)|!INVALID))
proptrans.df %<>% rowwise() %>% mutate(rscore=(round(SCORE,digits=5)))
```

## Preliminary Diagnostics
```{r}
# diagnostic frequency table -- not in publication
results<-proptrans.df%>% xtabs(PROPOSED~actor+govlevel+year+stage,data=.)
ftable(results)
```
## Invalidations 
```{r}
# Table 4.1 for Row 1
res_events_grp.df <- proptrans.df %>% filter(actortype=="minor" | actortype=="major") %>% group_by(year) %>% summarise(events=sum(!VALIDPLAN),denominator=sum(PROPOSED,na.rm=TRUE),type="plan invalidations",category="compliance") 
res_events_grp.df %>% pivot_wider(names_from=year,values_from=c(events,denominator))  %>% group_by(category) %>% gt()  %>% tab_header(title = "Compliance Events Summary" ) 

# Table 4.2 Col 1:2
res_events_actors.df <- proptrans.df %>% filter(actortype=="minor" | actortype=="major") %>% group_by(year,actor) %>% summarise(events=sum(!VALIDPLAN),denominator=sum(PROPOSED,na.rm=TRUE),category="compliance")
res_events_actors.df %>% gt()

```
## Third Party Actors
*  All scored entries are in 2013
*  Three unknown actors - Junta, CLV, PRD51
*  Plans are scored, but not included
*  Also 2017 Jalisco plan by derfe submitted but not officially scored
```{r}
thirdpartyprop.df <-propfull.df %>% filter(actortype!="minor" & actortype!="major") %>% filter(stage==2 | stage==4) %>% filter(PROPOSED==TRUE)

# Table 4.1 R2
thirdpartyprop.df %>% group_by(year,actor) %>% summarise(ghostproposals=sum(PROPOSED,na.rm=TRUE))

```
## INE Interventions
```{r}
## aggregate proposal lists  by  year, edon
contestSum.df <-proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(2))) %>% group_by(year,edon) %>% summarize(phase2_plans=list(na.omit(rscore)))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & (stage %in% c(4))) %>% group_by(year,edon) %>% summarize(phase4_plans=list(na.omit(rscore))))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==3 & actor=="INE") %>% group_by(year,edon) %>% transmute(phase3_win=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==1 & actor=="Algorithm") %>% group_by(year,edon) %>% transmute(phase1_start=rscore))
contestSum.df %<>% left_join(proptrans.df %>% filter(VALIDPLAN==TRUE & stage==5 & actor=="INE") %>% group_by(year,edon) %>% transmute(final_win=rscore))
```
```{r}
## INE interventions
contestSum.df %<>% rowwise() %>% mutate(INEchanged_phase3 = !phase3_win %in% c(phase2_plans,phase1_start))
contestSum.df %<>% rowwise() %>% mutate(INEchanged_final = !final_win %in% c(phase4_plans,phase3_win))
contestSum.df %>% group_by(year) %>% summarize(intervene_start=sum(INEchanged_phase3),intervene_final=sum(INEchanged_final))
```


## Winning Plan Not Lowest Scoring Valid Plan
## Section 8 

```{r}
contestSum.df %<>% rowwise() %>% mutate(lowestscore = min(phase1_start,phase2_plans,phase3_win,phase4_plans),best_lost=final_win!=lowestscore)
contestSum.df %<>% rowwise() %>% mutate(final_unanimous=length(unique(phase4_plans))==1,section_eight=(final_unanimous&best_lost))
contestSum.df %>% group_by(year) %>% summarize(best_lost=sum(best_lost),section_eight=sum(section_eight))
```
## Rules Violations
```{r}


```
## Algorithmic Efficency 
```{r}
contestSum.df %<>% rowwise() %>% mutate(efficiency=(1-(phase1_start-lowestscore)/lowestscore)*100)
contestSum.df %>% group_by(year) %>% summarize(min_efficiency=min(efficiency),median_efficiency=median(efficiency), mean_efficiency=mean(efficiency))
contestSum.df %>% ggplot(aes(efficiency))+geom_histogram(bins=30)+facet_grid(rows=vars(year))
contestSum.df %>% ggplot(aes(x=edon,y=efficiency,fill=as.factor(year)))+geom_col(position="dodge", width=.5)
```
## Party Plan Breakdown
```{r}

```
## OLDER CODE
```{r}
#Winning scores

winscores <- subset(proposals.df,stage==5, select=c(SCORE,year,Entidad))
names(winscores)[1]<-"Winning.Score"
print (winscores)
```

```{r}
twin<-proposals.df %>% inner_join(winscores)

#cat("Which actors won ...")
# by(twin,c(twin["Entidad"], twin["year"]),function(x)x["actor"],simplify=FALSE)

```

```{r}
# Analyze transparency compliance

cat ("Invalidations")
xtabs(PROPOSED~INVALID+year, proposals.df)
ftable(xtabs(PROPOSED~INVALID+actor+year+stage, proposals.df))

lowvalid <- aggregate(formula=SCORE~year+Entidad,data=subset(proposals.df,PROPOSED==TRUE & (is.na(INVALID) | INVALID==FALSE)),FUN=min)
names(lowvalid)[3]<-"Lowestv.Score"

unanimous <- aggregate(formula=SCORE~year+Entidad,data=subset(proposals.df,stage==4& PROPOSED==TRUE & (is.na(INVALID) | INVALID==FALSE)),FUN=function(x)length(unique(x))==1)
names(unanimous)[3]<-"UnanimousLast"



tmpBest<- within(merge(lowvalid,winscores, by= c("year","Entidad")), LowestWon<-(Lowestv.Score==Winning.Score))
tmpBest<-as_tibble(tmpBest)
xtabs(~LowestWon+year,tmpBest)

tmpBest<-merge(tmpBest,unanimous)
tmpBest<-within(tmpBest,RulesViolation <- !LowestWon & !UnanimousLast) 
round1p <- aggregate(formula=SCORE~year+Entidad,data=subset(proposals.df,stage==1),FUN=c)
 names(round1p)[3]<-"round1.scores"

 round2p <- aggregate(formula=SCORE~year+Entidad,data=subset(proposals.df,stage==2& PROPOSED==TRUE & (is.na(INVALID) | INVALID==FALSE)),FUN=c)
 names(round2p)[3]<-"round2.scores"
 round3p <- aggregate(formula=SCORE~year+Entidad,data=subset(proposals.df,stage==3& PROPOSED==TRUE & (is.na(INVALID) | INVALID==FALSE)),FUN=c)
  names(round3p)[3]<-"round3.scores"

 round4p <- aggregate(formula=SCORE~year+Entidad,data=subset(proposals.df,stage==4& PROPOSED==TRUE & (is.na(INVALID) | INVALID==FALSE)),FUN=c)
   names(round4p)[3]<-"round4.scores"

round5p <- aggregate(formula=SCORE~year+Entidad,data=subset(proposals.df,stage==5& PROPOSED==TRUE & (is.na(INVALID) | INVALID==FALSE)),FUN=c)
  names(round5p)[3]<-"round5.scores"
    tmpBest<-merge(tmpBest,round1p,all.x=TRUE)  

  tmpBest<-merge(tmpBest,round2p,all.x=TRUE)  
  tmpBest<-merge(tmpBest,round3p,all.x=TRUE)
    tmpBest<-merge(tmpBest,round4p,all.x=TRUE)
      tmpBest<-merge(tmpBest,round5p,all.x=TRUE)

tmpBest$IneNewRound3<-apply(tmpBest,1,function(x)length(intersect(unlist(x$round3.scores),union(unlist(x["round1.scores"]),unlist(x["round2.scores"]))))==0)

tmpBest$IneNewRound5<-apply(tmpBest,1,function(x)length(intersect(unlist(x$round5.scores),union(unlist(x["round3.scores"]),unlist(x["round4.scores"]))))==0)

tmpBest %<>% mutate(IneNew=IneNewRound3 | IneNewRound5)



cat("lowest valid proposal winning")
xtabs(~LowestWon+year,tmpBest)
cat("party unanimity in the last round")
xtabs(~UnanimousLast+year,tmpBest)
cat("Rules violation (not lowest & not unanimous)")
xtabs(~RulesViolation+year,tmpBest)
cat("INE new proposals")
xtabs(~IneNew+year,tmpBest)


```
